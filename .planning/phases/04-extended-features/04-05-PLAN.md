---
phase: 04-extended-features
plan: 05
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/components/Editor/EditorCore.tsx
  - src/extensions/ResizableImage/ResizableImage.ts
  - src/extensions/ResizableImage/ImageView.tsx
  - src/extensions/ResizableImage/index.ts
  - src/styles/images.css
  - src/extensions/SlashCommands/commands.ts
autonomous: true

must_haves:
  truths:
    - "User can insert image via drag/drop"
    - "User can insert image via paste"
    - "User can insert image via /image slash command"
    - "User can resize image by dragging corner handles"
    - "Images maintain aspect ratio during resize"
    - "Large images trigger size warning"
  artifacts:
    - path: "src/extensions/ResizableImage/ResizableImage.ts"
      provides: "Custom image extension with resize"
      contains: "Node.create"
    - path: "src/extensions/ResizableImage/ImageView.tsx"
      provides: "React view with resize handles"
      contains: "NodeViewWrapper"
    - path: "src/styles/images.css"
      provides: "Image styling and resize handle appearance"
      contains: ".resizable-image"
  key_links:
    - from: "EditorCore.tsx"
      to: "ResizableImage"
      via: "extensions array"
      pattern: "ResizableImage"
    - from: "ResizableImage.ts"
      to: "ImageView.tsx"
      via: "ReactNodeViewRenderer"
      pattern: "ReactNodeViewRenderer.*ImageView"
---

<objective>
Implement core image support with insertion methods and resize capability.

Purpose: Images are essential for rich documents. This plan covers the foundation - insertion and resize. Advanced features (cropping, effects, editor mode) are deferred per scope analysis.

Output: Drag/drop, paste, and slash command image insertion with corner-handle resizing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extended-features/04-CONTEXT.md
@.planning/phases/04-extended-features/04-RESEARCH.md
@.planning/phases/04-extended-features/04-02-SUMMARY.md
@src/components/Editor/EditorCore.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Custom resizable image extension</name>
  <files>
    src/extensions/ResizableImage/ResizableImage.ts
    src/extensions/ResizableImage/ImageView.tsx
    src/extensions/ResizableImage/index.ts
    src/styles/images.css
    src/components/Editor/EditorCore.tsx
  </files>
  <action>
    Create src/extensions/ResizableImage/ResizableImage.ts:
    ```typescript
    import { Node, mergeAttributes } from '@tiptap/core'
    import { ReactNodeViewRenderer } from '@tiptap/react'
    import ImageView from './ImageView'

    export const ResizableImage = Node.create({
      name: 'image',
      group: 'block',
      draggable: true,
      atom: true,

      addAttributes() {
        return {
          src: { default: null },
          alt: { default: null },
          title: { default: null },
          width: { default: null },  // Stored width for persistence
          height: { default: null },
          alignment: { default: 'center' },  // left, center, right
        }
      },

      parseHTML() {
        return [{ tag: 'img[src]' }]
      },

      renderHTML({ HTMLAttributes }) {
        return ['img', mergeAttributes(HTMLAttributes)]
      },

      addNodeView() {
        return ReactNodeViewRenderer(ImageView)
      },

      addCommands() {
        return {
          setImage: (options) => ({ commands }) => {
            return commands.insertContent({
              type: 'image',
              attrs: options,
            })
          },
        }
      },
    })
    ```

    Create src/extensions/ResizableImage/ImageView.tsx:
    ```typescript
    import { NodeViewWrapper } from '@tiptap/react'
    import { useState, useRef, useCallback } from 'react'
    import type { NodeViewProps } from '@tiptap/react'

    export default function ImageView({ node, updateAttributes, selected }: NodeViewProps) {
      const { src, alt, width, height, alignment } = node.attrs
      const [isResizing, setIsResizing] = useState(false)
      const imageRef = useRef<HTMLImageElement>(null)
      const startPos = useRef({ x: 0, y: 0, width: 0, height: 0 })

      const handleResizeStart = useCallback((e: React.MouseEvent) => {
        e.preventDefault()
        if (!imageRef.current) return

        const rect = imageRef.current.getBoundingClientRect()
        startPos.current = {
          x: e.clientX,
          y: e.clientY,
          width: rect.width,
          height: rect.height,
        }
        setIsResizing(true)

        const handleMouseMove = (e: MouseEvent) => {
          const deltaX = e.clientX - startPos.current.x
          const aspectRatio = startPos.current.height / startPos.current.width
          const newWidth = Math.max(100, startPos.current.width + deltaX)
          const newHeight = newWidth * aspectRatio

          if (imageRef.current) {
            imageRef.current.style.width = `${newWidth}px`
            imageRef.current.style.height = `${newHeight}px`
          }
        }

        const handleMouseUp = (e: MouseEvent) => {
          const deltaX = e.clientX - startPos.current.x
          const aspectRatio = startPos.current.height / startPos.current.width
          const newWidth = Math.max(100, startPos.current.width + deltaX)
          const newHeight = Math.round(newWidth * aspectRatio)

          updateAttributes({ width: Math.round(newWidth), height: newHeight })
          setIsResizing(false)

          document.removeEventListener('mousemove', handleMouseMove)
          document.removeEventListener('mouseup', handleMouseUp)
        }

        document.addEventListener('mousemove', handleMouseMove)
        document.addEventListener('mouseup', handleMouseUp)
      }, [updateAttributes])

      return (
        <NodeViewWrapper
          className={`resizable-image ${selected ? 'selected' : ''}`}
          data-alignment={alignment}
        >
          <div className="image-container">
            <img
              ref={imageRef}
              src={src}
              alt={alt || ''}
              style={{
                width: width ? `${width}px` : 'auto',
                height: height ? `${height}px` : 'auto',
                maxWidth: '100%',
              }}
              draggable={false}
            />
            {selected && (
              <div
                className="resize-handle resize-handle-se"
                onMouseDown={handleResizeStart}
              />
            )}
          </div>
        </NodeViewWrapper>
      )
    }
    ```

    Create src/styles/images.css:
    ```css
    .resizable-image {
      display: flex;
      position: relative;
    }

    .resizable-image[data-alignment="left"] {
      justify-content: flex-start;
    }

    .resizable-image[data-alignment="center"] {
      justify-content: center;
    }

    .resizable-image[data-alignment="right"] {
      justify-content: flex-end;
    }

    .image-container {
      position: relative;
      display: inline-block;
    }

    .resizable-image img {
      display: block;
      max-width: 100%;
    }

    .resizable-image.selected .image-container {
      outline: 2px solid var(--color-primary, #3b82f6);
    }

    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--color-primary, #3b82f6);
      border: 2px solid white;
      border-radius: 2px;
    }

    .resize-handle-se {
      bottom: -6px;
      right: -6px;
      cursor: se-resize;
    }
    ```

    Register in EditorCore.tsx:
    - Import ResizableImage from extensions/ResizableImage
    - Add to extensions array (this replaces default Image if any)
    - Import images.css
  </action>
  <verify>
    Use editor.commands.setImage({ src: 'https://picsum.photos/400/300' }) in console. Image appears. Click image, see blue outline and resize handle. Drag handle, image resizes maintaining aspect ratio.
  </verify>
  <done>
    Custom image extension with corner-handle resize works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Drag/drop and paste image handling</name>
  <files>
    src/components/Editor/EditorCore.tsx
    src/lib/imageUtils.ts
  </files>
  <action>
    Create src/lib/imageUtils.ts:
    ```typescript
    // Size threshold for warning (2MB)
    export const IMAGE_SIZE_WARNING_THRESHOLD = 2 * 1024 * 1024

    export function fileToBase64(file: File): Promise<string> {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = () => resolve(reader.result as string)
        reader.onerror = reject
        reader.readAsDataURL(file)
      })
    }

    export function isImageFile(file: File): boolean {
      return file.type.startsWith('image/')
    }

    export function checkImageSize(file: File): { ok: boolean; size: number } {
      return {
        ok: file.size < IMAGE_SIZE_WARNING_THRESHOLD,
        size: file.size,
      }
    }

    export function formatFileSize(bytes: number): string {
      if (bytes < 1024) return `${bytes} B`
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
    }
    ```

    In EditorCore.tsx, add event handlers to the editor config:
    ```typescript
    editorProps: {
      handleDrop: (view, event, slice, moved) => {
        if (moved || !event.dataTransfer?.files.length) return false

        const files = Array.from(event.dataTransfer.files).filter(isImageFile)
        if (files.length === 0) return false

        files.forEach(async (file) => {
          const sizeCheck = checkImageSize(file)
          if (!sizeCheck.ok) {
            // Show warning dialog (can use window.confirm for now)
            const proceed = window.confirm(
              `Image is ${formatFileSize(sizeCheck.size)}. Large images may slow down the editor. Continue?`
            )
            if (!proceed) return
          }

          const src = await fileToBase64(file)
          const { state } = view
          const pos = view.posAtCoords({ left: event.clientX, top: event.clientY })

          if (pos) {
            editor?.commands.setImage({ src })
          }
        })

        return true
      },

      handlePaste: (view, event, slice) => {
        const items = event.clipboardData?.items
        if (!items) return false

        for (const item of items) {
          if (item.type.startsWith('image/')) {
            const file = item.getAsFile()
            if (!file) continue

            const sizeCheck = checkImageSize(file)
            if (!sizeCheck.ok) {
              const proceed = window.confirm(
                `Image is ${formatFileSize(sizeCheck.size)}. Large images may slow down the editor. Continue?`
              )
              if (!proceed) return true
            }

            fileToBase64(file).then((src) => {
              editor?.commands.setImage({ src })
            })

            return true
          }
        }

        return false
      },
    }
    ```

    Note: Images are embedded as base64 per CONTEXT decision - fully portable in .serq.html files.
  </action>
  <verify>
    Drag an image file from Finder into editor. Image appears. Copy an image in another app, paste into editor. Image appears. Try a >2MB image, see warning dialog.
  </verify>
  <done>
    Drag/drop and paste image insertion works with size warnings.
  </done>
</task>

<task type="auto">
  <name>Task 3: Slash command and basic positioning</name>
  <files>
    src/extensions/SlashCommands/commands.ts
    src/extensions/ResizableImage/ImageView.tsx
    src/styles/images.css
  </files>
  <action>
    Add /image slash command:
    In SlashCommands/commands.ts:
    ```typescript
    {
      title: 'Image',
      description: 'Upload an image',
      icon: 'ðŸ–¼ï¸',  // Or proper icon
      command: ({ editor, range }) => {
        editor.chain().focus().deleteRange(range).run()

        // Create hidden file input
        const input = document.createElement('input')
        input.type = 'file'
        input.accept = 'image/*'
        input.onchange = async () => {
          const file = input.files?.[0]
          if (!file) return

          const sizeCheck = checkImageSize(file)
          if (!sizeCheck.ok) {
            const proceed = window.confirm(
              `Image is ${formatFileSize(sizeCheck.size)}. Large images may slow down the editor. Continue?`
            )
            if (!proceed) return
          }

          const src = await fileToBase64(file)
          editor.commands.setImage({ src })
        }
        input.click()
      },
    }
    ```

    Add image alignment controls to ImageView.tsx:
    - When selected, show 3 alignment buttons above image (left, center, right)
    - Click button calls updateAttributes({ alignment: 'left|center|right' })
    - Style buttons in images.css

    Update images.css:
    ```css
    .image-toolbar {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .image-toolbar button {
      padding: 4px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
    }

    .image-toolbar button:hover {
      background: #f3f4f6;
    }

    .image-toolbar button.active {
      background: #e5e7eb;
    }

    /* Dark mode */
    :root[data-theme="dark"] .image-toolbar {
      background: #262626;
      border-color: #3f3f46;
    }

    :root[data-theme="dark"] .image-toolbar button:hover {
      background: #3f3f46;
    }
    ```
  </action>
  <verify>
    Type "/image" in editor, select Image from menu. File picker opens. Select image, it appears in editor. Click image, see alignment buttons. Change alignment to left, image aligns left.
  </verify>
  <done>
    /image slash command and basic alignment controls work.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Type "/image" - file picker opens
2. Select an image - appears centered in document
3. Drag different image from Finder - inserts at drop location
4. Copy image in browser, paste - inserts in editor
5. Click image - selected (blue outline, resize handle)
6. Drag resize handle - image resizes, maintains aspect ratio
7. Click alignment buttons - image moves left/center/right
8. Try >2MB image - warning appears, can proceed or cancel
9. Save document, reopen - images persist (base64 in .serq.html)
</verification>

<success_criteria>
- Images insertable via drag/drop from filesystem
- Images insertable via paste from clipboard
- Images insertable via /image slash command with file picker
- Image resize via corner handles maintains aspect ratio
- Minimum image width: 100px
- Alignment buttons (left/center/right) change image position
- Large image warning at 2MB threshold
- Images saved as base64 in document
</success_criteria>

<output>
After completion, create `.planning/phases/04-extended-features/04-05-SUMMARY.md`
</output>
