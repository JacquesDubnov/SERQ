---
phase: 04-extended-features
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/Callout/Callout.ts
  - src/extensions/Callout/CalloutView.tsx
  - src/extensions/Callout/index.ts
  - src/components/Editor/EditorCore.tsx
  - src/styles/callout.css
autonomous: true

must_haves:
  truths:
    - "User can insert a callout block"
    - "User can choose callout color from theme palette"
    - "User can type content inside callout"
    - "User can make callout collapsible"
    - "User can add icon to callout"
    - "Callout has 4px rounded corners matching tables"
  artifacts:
    - path: "src/extensions/Callout/Callout.ts"
      provides: "TipTap node extension for callout blocks"
      contains: "Node.create"
    - path: "src/extensions/Callout/CalloutView.tsx"
      provides: "React component for callout rendering"
      contains: "NodeViewWrapper"
    - path: "src/styles/callout.css"
      provides: "Callout styling with colors and collapse"
      contains: ".callout"
  key_links:
    - from: "Callout.ts"
      to: "CalloutView.tsx"
      via: "ReactNodeViewRenderer"
      pattern: "ReactNodeViewRenderer.*CalloutView"
    - from: "EditorCore.tsx"
      to: "Callout.ts"
      via: "extensions array"
      pattern: "Callout"
---

<objective>
Create custom Callout block extension with color-based styling (not semantic types).

Purpose: Callouts/admonitions highlight important content. Per CONTEXT, they are color-based (not info/warning/error semantic types) and pull colors from the active document theme.

Output: Insertable callout block with color selection, optional icon, and collapsible option.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extended-features/04-CONTEXT.md
@.planning/phases/04-extended-features/04-RESEARCH.md
@src/components/Editor/EditorCore.tsx
@src/lib/presets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Callout node extension</name>
  <files>
    src/extensions/Callout/Callout.ts
    src/extensions/Callout/CalloutView.tsx
    src/extensions/Callout/index.ts
    src/components/Editor/EditorCore.tsx
  </files>
  <action>
    Create src/extensions/Callout/Callout.ts:
    ```typescript
    import { Node, mergeAttributes } from '@tiptap/core'
    import { ReactNodeViewRenderer } from '@tiptap/react'
    import CalloutView from './CalloutView'

    export const Callout = Node.create({
      name: 'callout',
      group: 'block',
      content: 'block+',  // Allow any block content inside (paragraphs, lists, headings)

      addAttributes() {
        return {
          color: { default: 'blue' },  // Color name, maps to CSS variable
          icon: { default: null },     // Optional icon (emoji or icon name)
          collapsed: { default: false },
          collapsible: { default: false },  // Whether collapse is enabled
        }
      },

      parseHTML() {
        return [{ tag: 'div[data-callout]' }]
      },

      renderHTML({ HTMLAttributes }) {
        return ['div', mergeAttributes({ 'data-callout': '' }, HTMLAttributes), 0]
      },

      addNodeView() {
        return ReactNodeViewRenderer(CalloutView)
      },

      addCommands() {
        return {
          insertCallout: (attrs = {}) => ({ commands }) => {
            return commands.insertContent({
              type: 'callout',
              attrs,
              content: [{ type: 'paragraph' }],
            })
          },
          toggleCalloutCollapse: () => ({ commands, state }) => {
            // Toggle collapsed state of selected callout
            // Implementation detail for later
            return true
          },
        }
      },
    })
    ```

    Create src/extensions/Callout/CalloutView.tsx:
    ```typescript
    import { NodeViewWrapper, NodeViewContent } from '@tiptap/react'
    import type { NodeViewProps } from '@tiptap/react'

    export default function CalloutView({ node, updateAttributes, selected }: NodeViewProps) {
      const { color, icon, collapsed, collapsible } = node.attrs

      // Map color name to CSS variable from theme
      const bgColor = `var(--callout-${color}-bg, var(--color-${color}-100))`
      const borderColor = `var(--callout-${color}-border, var(--color-${color}-500))`

      return (
        <NodeViewWrapper
          className={`callout ${selected ? 'callout-selected' : ''} ${collapsed ? 'callout-collapsed' : ''}`}
          data-color={color}
          style={{
            backgroundColor: bgColor,
            borderRadius: '4px',
          }}
        >
          <div className="callout-header" contentEditable={false}>
            {icon && <span className="callout-icon">{icon}</span>}
            {collapsible && (
              <button
                className="callout-collapse-btn"
                onClick={() => updateAttributes({ collapsed: !collapsed })}
              >
                {collapsed ? '▶' : '▼'}
              </button>
            )}
          </div>
          <NodeViewContent
            className="callout-content"
            style={{ display: collapsed ? 'none' : 'block' }}
          />
        </NodeViewWrapper>
      )
    }
    ```

    Register in EditorCore.tsx:
    - Import Callout from extensions/Callout
    - Add to extensions array
  </action>
  <verify>
    In dev tools console: editor.commands.insertCallout({ color: 'blue' })
    Callout block appears with blue background. Can type inside it.
  </verify>
  <done>
    Callout node extension created and renders with editable content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Callout styling and color palette</name>
  <files>
    src/styles/callout.css
    src/extensions/Callout/CalloutView.tsx
    src/lib/calloutColors.ts
  </files>
  <action>
    Create src/lib/calloutColors.ts:
    - Define 8 callout colors that work in light and dark mode
    - Each color: { id, name, bgLight, bgDark, accentLight, accentDark }
    - Colors: blue, green, yellow, orange, red, purple, pink, gray
    - Export CALLOUT_COLORS array

    Create src/styles/callout.css:
    ```css
    .callout {
      position: relative;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }

    .callout-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .callout-icon {
      font-size: 1.25rem;
    }

    .callout-collapse-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      opacity: 0.6;
    }

    .callout-collapse-btn:hover {
      opacity: 1;
    }

    .callout-content {
      /* Content container */
    }

    .callout-content > *:first-child {
      margin-top: 0;
    }

    .callout-content > *:last-child {
      margin-bottom: 0;
    }

    .callout-collapsed .callout-content {
      display: none;
    }

    .callout-selected {
      outline: 2px solid var(--color-primary);
    }

    /* Color variants using CSS variables */
    .callout[data-color="blue"] {
      background-color: var(--callout-blue-bg, #dbeafe);
    }
    .callout[data-color="green"] {
      background-color: var(--callout-green-bg, #dcfce7);
    }
    /* ... repeat for all 8 colors ... */

    /* Dark mode variants */
    :root[data-theme="dark"] .callout[data-color="blue"] {
      background-color: var(--callout-blue-bg-dark, #1e3a5f);
    }
    /* ... etc ... */
    ```

    Update CalloutView.tsx:
    - Import CALLOUT_COLORS
    - Use data-color attribute for CSS styling instead of inline styles
    - Keep border-radius: 4px inline (matches tables per CONTEXT)

    Import callout.css in EditorCore.tsx or main entry.
  </action>
  <verify>
    Insert callouts with different colors. Toggle dark mode. All colors should be visible and readable in both themes.
  </verify>
  <done>
    Callout colors work in light and dark mode with proper contrast.
  </done>
</task>

<task type="auto">
  <name>Task 3: Callout context menu and toolbar integration</name>
  <files>
    src/extensions/Callout/CalloutContextMenu.tsx
    src/extensions/Callout/CalloutView.tsx
    src/components/Editor/EditorToolbar.tsx
    src/extensions/SlashCommands/commands.ts
  </files>
  <action>
    Create src/extensions/Callout/CalloutContextMenu.tsx:
    - Show on right-click when inside callout
    - Menu options:
      - Color picker (8 color swatches in a row)
      - Add/change icon (preset emoji picker: info, warning, tip, note, etc.)
      - Toggle collapsible
      - Delete callout
    - Position at mouse coordinates
    - Close on click outside

    Update CalloutView.tsx:
    - Add onContextMenu handler to show CalloutContextMenu
    - Pass updateAttributes to menu for changing color/icon/collapsible
    - Add delete option that removes the node

    Add callout button to EditorToolbar.tsx:
    - Icon: quote bubble or box with exclamation
    - Click inserts default callout (blue, no icon, not collapsible)
    - Could add dropdown for color preselection (optional enhancement)

    Add to slash commands (if 04-02 complete):
    - /callout - insert blue callout
    - /callout-blue, /callout-green, etc. (optional)
    - Or just /callout with color picker in callout after insertion
  </action>
  <verify>
    Insert callout via toolbar button. Right-click, change color to green. Add icon. Toggle collapsible on. Collapse and expand. Delete via context menu.
  </verify>
  <done>
    Callout fully functional with context menu controls, toolbar insertion, and slash command.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Click callout button in toolbar - blue callout appears
2. Type "/callout" in editor - callout inserted via slash command
3. Right-click callout - context menu with color picker
4. Change color to orange - background updates
5. Add icon (e.g., lightbulb) - icon appears
6. Enable collapsible - collapse button appears
7. Click collapse - content hides
8. Click expand - content shows
9. Toggle dark mode - callout colors adapt
10. Delete callout via context menu
</verification>

<success_criteria>
- Callout block insertable via toolbar and slash command
- Content editable inside callout (paragraphs, lists, headings)
- 8 color options available via context menu
- Colors work in both light and dark mode
- Optional icon addable
- Collapsible toggle works
- 4px border radius matches table styling
- Context menu provides all callout controls
</success_criteria>

<output>
After completion, create `.planning/phases/04-extended-features/04-04-SUMMARY.md`
</output>
