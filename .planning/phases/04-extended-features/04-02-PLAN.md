---
phase: 04-extended-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/CommandPalette/CommandPalette.tsx
  - src/components/CommandPalette/commands.ts
  - src/components/CommandPalette/index.ts
  - src/extensions/SlashCommands/SlashCommands.ts
  - src/extensions/SlashCommands/SlashMenu.tsx
  - src/extensions/SlashCommands/commands.ts
  - src/extensions/SlashCommands/index.ts
  - src/components/Editor/EditorCore.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can open command palette with Cmd+K or Cmd+P"
    - "User can type to filter commands"
    - "User can execute any available command from palette"
    - "User can type / in document to open slash menu"
    - "User can insert blocks via slash commands (/table, /heading, etc.)"
    - "Commands show keyboard shortcut hints"
  artifacts:
    - path: "src/components/CommandPalette/CommandPalette.tsx"
      provides: "Modal command palette UI"
      contains: "Command.Dialog"
    - path: "src/components/CommandPalette/commands.ts"
      provides: "All available commands with metadata"
      exports: ["commands", "CommandItem"]
    - path: "src/extensions/SlashCommands/SlashCommands.ts"
      provides: "TipTap extension for slash commands"
      contains: "@tiptap/suggestion"
    - path: "src/extensions/SlashCommands/SlashMenu.tsx"
      provides: "Dropdown menu for slash commands"
      exports: ["SlashMenu"]
  key_links:
    - from: "CommandPalette.tsx"
      to: "commands.ts"
      via: "import and render"
      pattern: "import.*commands"
    - from: "SlashCommands.ts"
      to: "SlashMenu.tsx"
      via: "ReactRenderer"
      pattern: "ReactNodeRenderer|ReactRenderer.*SlashMenu"
    - from: "EditorCore.tsx"
      to: "SlashCommands"
      via: "extensions array"
      pattern: "SlashCommands"
---

<objective>
Implement command palette (Cmd+K) and slash commands (/) for quick action access.

Purpose: Command interfaces are the fastest way to access features without hunting through menus. Users expect Cmd+K from VS Code/Linear/Notion and / from Notion/Slack.

Output: Working command palette with cmdk and slash commands with @tiptap/suggestion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extended-features/04-CONTEXT.md
@.planning/phases/04-extended-features/04-RESEARCH.md
@src/components/Editor/EditorCore.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Command palette with cmdk</name>
  <files>
    package.json
    src/components/CommandPalette/CommandPalette.tsx
    src/components/CommandPalette/commands.ts
    src/components/CommandPalette/index.ts
    src/styles/command-palette.css
    src/App.tsx
  </files>
  <action>
    Install cmdk:
    ```bash
    npm install cmdk
    ```

    Create src/components/CommandPalette/commands.ts:
    - Define CommandItem interface: { id, title, shortcut?, group, action: (editor) => void }
    - Export commands array with all available actions grouped by category:
      - Format: Bold (Cmd+B), Italic (Cmd+I), Underline (Cmd+U), Strikethrough, Code
      - Headings: H1, H2, H3, H4, H5, H6
      - Blocks: Paragraph, Blockquote, Code Block, Bullet List, Numbered List
      - Alignment: Left, Center, Right, Justify
      - Insert: Table, Horizontal Rule, Link (future: Image, Callout)
      - File: New, Open, Save, Save As (reference existing useFileOperations)
      - View: Toggle Dark Mode, Focus Mode (placeholder)

    Create src/components/CommandPalette/CommandPalette.tsx:
    - Use Command.Dialog from cmdk
    - Accept editor prop (Editor | null)
    - Accept isOpen and onOpenChange props for controlled state
    - Command.Input with placeholder "Type a command or search..."
    - Command.List with Command.Empty for no results
    - Command.Group for each category
    - Command.Item for each command, show shortcut on right side
    - On select: execute command action, close palette
    - Style with command-palette.css:
      - Modal centered, max-width 600px
      - Rounded corners, shadow
      - Input at top, list scrollable below
      - Keyboard navigation (already built into cmdk)

    Wire up in App.tsx:
    - Add state: const [commandPaletteOpen, setCommandPaletteOpen] = useState(false)
    - Add keyboard listener for Cmd+K and Cmd+P (both should open)
    - Render CommandPalette component with editor, isOpen, onOpenChange
    - Ensure palette closes on command execution
  </action>
  <verify>
    Press Cmd+K, palette opens. Type "bold", Bold command appears. Press Enter, text gets bolded (with selection). Press Escape, palette closes.
  </verify>
  <done>
    Command palette opens with Cmd+K/Cmd+P, filters commands, executes on selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Slash commands extension</name>
  <files>
    src/extensions/SlashCommands/SlashCommands.ts
    src/extensions/SlashCommands/SlashMenu.tsx
    src/extensions/SlashCommands/commands.ts
    src/extensions/SlashCommands/index.ts
    src/styles/slash-menu.css
    src/components/Editor/EditorCore.tsx
  </files>
  <action>
    Install tippy.js for positioning (if not already present):
    ```bash
    npm install tippy.js
    ```

    Create src/extensions/SlashCommands/commands.ts:
    - SlashCommandItem interface: { title, description, icon?, command: (editor, range) => void }
    - Export slashCommands array for insert-type actions:
      - Headings: /h1, /h2, /h3, /heading1, /heading2, /heading3
      - Text: /paragraph, /text
      - Lists: /bullet, /numbered, /list, /ordered
      - Blocks: /quote, /blockquote, /code, /codeblock
      - Media: /table, /divider, /hr, /rule
      - Future placeholders: /image, /callout (add once those features exist)

    Create src/extensions/SlashCommands/SlashMenu.tsx:
    - Render as dropdown list at cursor position
    - Accept items, command, and selectedIndex props
    - Show icon, title, description for each item
    - Highlight selected item (keyboard navigable)
    - Use forwardRef with useImperativeHandle for onKeyDown:
      - ArrowUp/Down: navigate
      - Enter: select
      - Escape: close
    - Style with slash-menu.css:
      - Dropdown shadow, rounded corners
      - Max height with scroll
      - Match interface theme (dark/light)

    Create src/extensions/SlashCommands/SlashCommands.ts:
    - Use Extension.create with name 'slashCommands'
    - Use Suggestion from @tiptap/suggestion
    - Config: char: '/', command executes item.command
    - items: filter slashCommands by query
    - render: Use ReactRenderer + tippy.js for popup
    - On onStart: create popup at clientRect
    - On onUpdate: update position
    - On onKeyDown: pass to SlashMenu ref
    - On onExit: destroy popup

    Add SlashCommands to EditorCore.tsx extensions array.

    Pattern from RESEARCH.md:
    ```typescript
    render: () => {
      let component: ReactRenderer
      let popup: Instance

      return {
        onStart: (props) => {
          component = new ReactRenderer(SlashMenu, { props, editor: props.editor })
          popup = tippy('body', {
            getReferenceClientRect: props.clientRect,
            appendTo: () => document.body,
            content: component.element,
            showOnCreate: true,
            interactive: true,
            trigger: 'manual',
            placement: 'bottom-start',
          })
        },
        onUpdate: (props) => { component.updateProps(props) },
        onKeyDown: (props) => { return component.ref?.onKeyDown?.(props) },
        onExit: () => { popup.destroy(); component.destroy() },
      }
    }
    ```
  </action>
  <verify>
    Type "/" in editor, dropdown appears. Type "h2", heading 2 option highlighted. Press Enter, current line becomes H2. Menu closes.
  </verify>
  <done>
    Slash commands trigger inline dropdown, filter as you type, insert blocks on selection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Command integration and keyboard shortcuts display</name>
  <files>
    src/components/CommandPalette/CommandPalette.tsx
    src/components/CommandPalette/commands.ts
    src/hooks/useKeyboardShortcuts.ts
    src/styles/command-palette.css
  </files>
  <action>
    Enhance commands.ts:
    - Ensure all commands have accurate shortcut strings
    - Format shortcuts consistently: "Cmd+B" on Mac (detect via navigator.platform or navigator.userAgentData)
    - Add jump-to commands: "Go to heading" (placeholder for outline integration)

    Update CommandPalette.tsx rendering:
    - Show shortcut hints right-aligned in each Command.Item
    - Use kbd styling for shortcut text (monospace, subtle background)
    - Group commands visually with Command.Group headings

    Verify existing useKeyboardShortcuts.ts shortcuts match command palette hints:
    - If discrepancy, update one to match
    - Shortcuts should be source of truth

    Add to command-palette.css:
    - kbd styling for shortcut hints
    - Proper spacing between title and shortcut
    - Hover/focus states for items

    Test focus management:
    - Opening palette should focus input
    - Closing should return focus to editor
    - Use onOpenChange to call editor.commands.focus() on close
  </action>
  <verify>
    Open command palette, see shortcuts next to each command. Close with Escape, cursor returns to editor position.
  </verify>
  <done>
    Command palette shows keyboard shortcut hints, focus management works correctly.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Press Cmd+K - palette opens
2. Press Cmd+P - palette opens (same behavior)
3. Type "italic" - Italic command visible with Cmd+I hint
4. Press Enter - Italic toggles (with text selected)
5. In editor, type "/" - slash menu appears at cursor
6. Type "table" - table option highlighted
7. Press Enter - table inserted (or placeholder if 04-01 not complete yet)
8. Press Escape at any point - menus close properly
</verification>

<success_criteria>
- Cmd+K and Cmd+P both open command palette
- Command palette filters as you type
- Commands execute correctly on selection
- Keyboard shortcut hints visible for all commands
- Slash commands trigger with / character
- Slash menu appears at cursor position
- Slash menu filters as you type
- Block insertion via slash commands works
- Focus returns to editor after closing palette
</success_criteria>

<output>
After completion, create `.planning/phases/04-extended-features/04-02-SUMMARY.md`
</output>
