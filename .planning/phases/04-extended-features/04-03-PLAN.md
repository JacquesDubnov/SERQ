---
phase: 04-extended-features
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/components/DocumentOutline/OutlinePanel.tsx
  - src/components/DocumentOutline/index.ts
  - src/hooks/useDocumentOutline.ts
  - src/components/Editor/EditorCore.tsx
  - src/components/CommandPalette/commands.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can see document outline with all headings"
    - "User can click heading in outline to navigate to it"
    - "Outline shows heading hierarchy (H1 > H2 > H3)"
    - "Active heading is highlighted in outline"
    - "User can access 'Go to heading' via command palette"
  artifacts:
    - path: "src/components/DocumentOutline/OutlinePanel.tsx"
      provides: "Sidebar panel showing heading tree"
      exports: ["OutlinePanel"]
    - path: "src/hooks/useDocumentOutline.ts"
      provides: "Hook to extract and track headings"
      exports: ["useDocumentOutline"]
    - path: "src/components/Editor/EditorCore.tsx"
      provides: "TableOfContents extension configured"
      contains: "TableOfContents"
  key_links:
    - from: "OutlinePanel.tsx"
      to: "useDocumentOutline.ts"
      via: "hook usage"
      pattern: "useDocumentOutline"
    - from: "useDocumentOutline.ts"
      to: "EditorCore.tsx"
      via: "TableOfContents onUpdate"
      pattern: "onUpdate.*anchors"
---

<objective>
Add document outline panel with heading navigation using TipTap's TableOfContents extension.

Purpose: Writers need to see document structure at a glance and jump to sections quickly, especially in long documents.

Output: Collapsible outline panel showing heading hierarchy with click-to-navigate.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extended-features/04-CONTEXT.md
@.planning/phases/04-extended-features/04-RESEARCH.md
@.planning/phases/04-extended-features/04-02-SUMMARY.md
@src/components/Editor/EditorCore.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure TableOfContents extension</name>
  <files>
    package.json
    src/components/Editor/EditorCore.tsx
    src/stores/editorStore.ts
  </files>
  <action>
    Install TableOfContents extension:
    ```bash
    npm install @tiptap/extension-table-of-contents
    ```

    In editorStore.ts, add outline state:
    ```typescript
    interface OutlineAnchor {
      id: string
      level: number
      textContent: string
      isActive: boolean
      isScrolledOver: boolean
      pos: number
      dom: HTMLElement
    }

    // Add to store state:
    outlineAnchors: OutlineAnchor[]
    setOutlineAnchors: (anchors: OutlineAnchor[]) => void
    ```

    In EditorCore.tsx:
    - Import TableOfContents and getHierarchicalIndexes from @tiptap/extension-table-of-contents
    - Configure extension:
      ```typescript
      TableOfContents.configure({
        anchorTypes: ['heading'],
        getIndex: getHierarchicalIndexes,
        onUpdate: (anchors) => {
          useEditorStore.getState().setOutlineAnchors(anchors)
        },
      })
      ```
    - Add to extensions array

    Note: getHierarchicalIndexes provides nested numbering (1, 1.1, 1.2, 2, etc.)
  </action>
  <verify>
    Add several headings to document (H1, H2, H3). Check React devtools or console log that outlineAnchors updates with heading data.
  </verify>
  <done>
    TableOfContents extension tracks headings and updates store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document outline panel UI</name>
  <files>
    src/components/DocumentOutline/OutlinePanel.tsx
    src/components/DocumentOutline/index.ts
    src/styles/outline.css
    src/App.tsx
  </files>
  <action>
    Create src/components/DocumentOutline/OutlinePanel.tsx:
    - Accept props: isOpen, onClose, interfaceColors, editor
    - Read outlineAnchors from useEditorStore
    - Render as slide-in panel from left side (mirror StylePanel pattern)
    - Show heading hierarchy with indentation:
      - H1: no indent
      - H2: 16px indent
      - H3: 32px indent
      - etc.
    - Each item shows:
      - Heading text (truncate if long)
      - Active indicator (dot or background) if isActive
    - On click: scroll to heading and set cursor
      ```typescript
      const navigateToHeading = (anchor: OutlineAnchor) => {
        anchor.dom.scrollIntoView({ behavior: 'smooth', block: 'start' })
        editor?.commands.setTextSelection(anchor.pos)
        editor?.commands.focus()
      }
      ```
    - Empty state: "No headings yet" when document has no headings

    Create src/styles/outline.css:
    - Panel styling (width 280px, full height, slide animation)
    - Heading items with hover state
    - Active heading highlighted
    - Indentation based on level
    - Close button in header

    Wire up in App.tsx:
    - Add state: const [outlineOpen, setOutlineOpen] = useState(false)
    - Add keyboard shortcut: Cmd+Shift+O to toggle outline
    - Add button in header (near style panels) for outline toggle
    - Render OutlinePanel with isOpen state
  </action>
  <verify>
    Create document with H1 "Introduction", H2 "Background", H2 "Methods", H3 "Data Collection". Open outline panel, see all 4 headings with proper hierarchy. Click "Methods", cursor jumps there.
  </verify>
  <done>
    Outline panel shows heading tree and navigates on click.
  </done>
</task>

<task type="auto">
  <name>Task 3: Command palette integration for heading navigation</name>
  <files>
    src/components/CommandPalette/commands.ts
    src/components/CommandPalette/CommandPalette.tsx
  </files>
  <action>
    Extend command palette with dynamic heading commands:

    In CommandPalette.tsx:
    - Read outlineAnchors from useEditorStore
    - Create a "Jump to" group that lists all document headings
    - Each heading item:
      - Title: heading text (prefix with H1/H2/H3 indicator)
      - Action: navigate to that heading (same as outline click)
    - This group should be filtered by query like other commands

    Update commands.ts:
    - Add "Show Outline" command (Cmd+Shift+O) that triggers outline panel open
    - Commands can accept a callback or context for dynamic actions

    Ensure heading commands update when document changes:
    - CommandPalette should re-read anchors on each open
    - Or use Zustand subscription for real-time updates

    Add empty state for headings section:
    - If no headings: show "No headings - add some to navigate" in gray
  </action>
  <verify>
    Open command palette, type "jump" or document heading text. See heading in results. Select it, cursor moves to that heading in document.
  </verify>
  <done>
    Command palette includes dynamic heading navigation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create document with mixed heading levels (H1, H2, H3)
2. Press Cmd+Shift+O - outline panel slides in from left
3. See heading hierarchy with proper indentation
4. Click a heading - document scrolls, cursor moves there
5. Active heading (where cursor is) should be highlighted
6. Press Cmd+K, type heading text - heading appears in Jump To group
7. Select heading from palette - navigates to it
8. Close outline, document should be unchanged
</verification>

<success_criteria>
- TableOfContents extension tracks all headings
- Outline panel shows heading hierarchy with indentation
- Click-to-navigate works with smooth scrolling
- Active heading highlighted in outline
- Command palette includes "Jump to heading" commands
- Outline panel toggles with Cmd+Shift+O
- Empty document shows appropriate empty state
</success_criteria>

<output>
After completion, create `.planning/phases/04-extended-features/04-03-SUMMARY.md`
</output>
