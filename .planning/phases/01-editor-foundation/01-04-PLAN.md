---
phase: 01-editor-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/stores/editorStore.ts
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Document title shows 'Untitled' for new documents"
    - "Title bar shows asterisk (*) when document has unsaved changes"
    - "User can type, format, and see changes reflect in UI state"
    - "All Phase 1 success criteria verified by human"
  artifacts:
    - path: "src/stores/editorStore.ts"
      provides: "Document metadata state"
      exports: ["useEditorStore"]
    - path: "src/App.tsx"
      provides: "Integrated editor application"
      contains: "useEditorStore"
  key_links:
    - from: "src/App.tsx"
      to: "src/stores/editorStore.ts"
      via: "Zustand hook"
      pattern: "useEditorStore"
    - from: "onUpdate callback"
      to: "markDirty()"
      via: "Store action"
      pattern: "markDirty\\(\\)"
---

<objective>
Wire final integration with Zustand state management and verify all Phase 1 success criteria with human testing.

Purpose: The editor needs to track document metadata (dirty state, title) for the UI and future file operations. This plan completes the foundation and verifies everything works together.

Output: Fully integrated editor with state management, ready for Phase 2 (File Management).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-editor-foundation/01-RESEARCH.md
@.planning/phases/01-editor-foundation/01-01-SUMMARY.md
@.planning/phases/01-editor-foundation/01-02-SUMMARY.md
@.planning/phases/01-editor-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand Store for Document State</name>
  <files>
    - /Users/jacquesdubnov/Coding/serq/src/stores/editorStore.ts
  </files>
  <action>
Create Zustand store for document metadata. IMPORTANT: Do NOT store document content in Zustand - TipTap owns content state. Only metadata lives here.

**src/stores/editorStore.ts:**
```typescript
import { create } from 'zustand'

interface DocumentMeta {
  path: string | null       // File path (null = unsaved)
  name: string              // Display name (file name or 'Untitled')
  isDirty: boolean          // Has unsaved changes
  lastSaved: Date | null    // Timestamp of last save
}

interface EditorState {
  // Document metadata
  document: DocumentMeta

  // UI state
  canvasWidth: 'narrow' | 'normal' | 'wide' | 'full'

  // Actions
  setDocument: (path: string | null, name: string) => void
  markDirty: () => void
  markSaved: () => void
  clearDocument: () => void
  setCanvasWidth: (width: 'narrow' | 'normal' | 'wide' | 'full') => void
}

export const useEditorStore = create<EditorState>((set) => ({
  // Initial state - new untitled document
  document: {
    path: null,
    name: 'Untitled',
    isDirty: false,
    lastSaved: null,
  },

  canvasWidth: 'normal',

  // Set document from file open
  setDocument: (path, name) => set({
    document: {
      path,
      name,
      isDirty: false,
      lastSaved: null,
    }
  }),

  // Mark document as having unsaved changes
  markDirty: () => set((state) => ({
    document: { ...state.document, isDirty: true }
  })),

  // Mark document as saved
  markSaved: () => set((state) => ({
    document: {
      ...state.document,
      isDirty: false,
      lastSaved: new Date(),
    }
  })),

  // Reset to new untitled document
  clearDocument: () => set({
    document: {
      path: null,
      name: 'Untitled',
      isDirty: false,
      lastSaved: null,
    }
  }),

  // Canvas width
  setCanvasWidth: (width) => set({ canvasWidth: width }),
}))
```

Key design decisions:
1. Document content NOT in store - TipTap is source of truth for content
2. isDirty tracks unsaved changes - set by onUpdate, cleared by save
3. path is null for unsaved documents - informs Save vs Save As behavior
4. canvasWidth in store - persists across session (will connect to preferences in Phase 5)
  </action>
  <verify>
```bash
cd /Users/jacquesdubnov/Coding/serq && npm run build
```
TypeScript compiles, Zustand types are correct.
  </verify>
  <done>Zustand store exists with document metadata and canvas width state.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Store and Add Title Bar</name>
  <files>
    - /Users/jacquesdubnov/Coding/serq/src/App.tsx
  </files>
  <action>
Update App.tsx to use the Zustand store and show document state in title bar:

**src/App.tsx:**
```typescript
import { useRef, useState, useEffect } from 'react'
import { EditorCore, EditorCoreRef } from './components/Editor/EditorCore'
import { EditorToolbar } from './components/Editor/EditorToolbar'
import { EditorWrapper } from './components/Editor/EditorWrapper'
import { Canvas } from './components/Layout/Canvas'
import { useEditorStore } from './stores/editorStore'
import { Editor } from '@tiptap/core'
import './styles/editor.css'

function App() {
  const editorRef = useRef<EditorCoreRef>(null)
  const [editor, setEditor] = useState<Editor | null>(null)

  // Zustand store
  const {
    document,
    canvasWidth,
    markDirty,
    setCanvasWidth
  } = useEditorStore()

  // Get editor instance after mount
  useEffect(() => {
    const timer = setTimeout(() => {
      const editorInstance = editorRef.current?.getEditor()
      if (editorInstance) {
        setEditor(editorInstance)
      }
    }, 0)
    return () => clearTimeout(timer)
  }, [])

  // Update window title to reflect document state
  useEffect(() => {
    const dirtyIndicator = document.isDirty ? '• ' : ''
    window.document.title = `${dirtyIndicator}${document.name} - SERQ`
  }, [document.name, document.isDirty])

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {/* Title bar */}
      <div className="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-center">
        <span className="text-sm text-gray-600">
          {document.isDirty && <span className="text-orange-500 mr-1">•</span>}
          {document.name}
        </span>
      </div>

      {/* Toolbar */}
      {editor && (
        <div className="bg-white border-b border-gray-200 sticky top-0 z-20">
          <div className="flex items-center justify-between">
            <EditorToolbar editor={editor} />

            {/* Canvas width control */}
            <div className="flex items-center gap-2 px-4 py-2 border-l border-gray-200">
              <span className="text-xs text-gray-500">Width:</span>
              <select
                value={canvasWidth}
                onChange={(e) => setCanvasWidth(e.target.value as typeof canvasWidth)}
                className="text-xs border border-gray-200 rounded px-2 py-1"
              >
                <option value="narrow">Narrow</option>
                <option value="normal">Normal</option>
                <option value="wide">Wide</option>
                <option value="full">Full</option>
              </select>
            </div>
          </div>
        </div>
      )}

      {/* Canvas with responsive container */}
      <Canvas width={canvasWidth}>
        <EditorWrapper editor={editor}>
          <EditorCore
            ref={editorRef}
            initialContent="<p>Start writing your document...</p>"
            onUpdate={() => {
              // Mark document as dirty when content changes
              markDirty()
            }}
          />
        </EditorWrapper>
      </Canvas>
    </div>
  )
}

export default App
```

Changes:
1. Title bar shows document name with dirty indicator (orange dot)
2. Window title updates to show dirty state and document name
3. onUpdate calls markDirty() - any content change marks document dirty
4. Canvas width comes from store instead of local state
  </action>
  <verify>
```bash
cd /Users/jacquesdubnov/Coding/serq && npm run tauri dev
```
1. Title bar shows "Untitled"
2. Type something - orange dot appears before "Untitled"
3. Window title updates to "• Untitled - SERQ"
4. Canvas width dropdown still works
  </verify>
  <done>App shows document name with dirty indicator, window title updates, all state managed by Zustand.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify All Phase 1 Success Criteria</name>
  <what-built>
Complete Phase 1 Editor Foundation:
- TipTap 3 editor with all critical performance configuration
- Formatting toolbar with active states
- Click-anywhere cursor placement
- Responsive canvas with width control
- Zustand state management for document metadata
  </what-built>
  <how-to-verify>
Run the app: `cd /Users/jacquesdubnov/Coding/serq && npm run tauri dev`

**Success Criteria Checklist:**

1. **Type and see text without lag (infinite-scroll canvas)**
   - [ ] App launches and shows editor
   - [ ] Type rapidly - text appears without noticeable lag
   - [ ] Add 50+ lines of text - scrolling is smooth
   - [ ] No horizontal scrollbar at any point

2. **Apply formatting via toolbar and shortcuts**
   - [ ] Select text, click Bold button - text becomes bold, button shows active
   - [ ] Click Bold again - text becomes normal, button shows inactive
   - [ ] Cmd+B toggles bold
   - [ ] Cmd+I toggles italic
   - [ ] Cmd+U toggles underline
   - [ ] H1/H2/H3 buttons create headings
   - [ ] Bullet and numbered list buttons work

3. **Click anywhere in empty space, cursor appears**
   - [ ] Click far below the last line of text
   - [ ] Cursor appears at end, new paragraph created if needed
   - [ ] Click in margin area (to the side of text) - editor focuses

4. **Resize window, content reflows**
   - [ ] Make window very narrow - text reflows, no horizontal scroll
   - [ ] Make window very wide - text stays within max-width
   - [ ] Change canvas width dropdown (narrow/normal/wide/full) - content changes width

5. **Undo/redo with full history**
   - [ ] Type several words, make formatting changes
   - [ ] Cmd+Z multiple times - each change undoes
   - [ ] Cmd+Shift+Z - changes redo
   - [ ] Undo/redo buttons in toolbar work and show disabled state appropriately

**Bonus Checks:**
- [ ] Title bar shows "Untitled" initially
- [ ] After typing, orange dot appears before title (dirty indicator)
- [ ] Window title shows "• Untitled - SERQ"
- [ ] React DevTools: EditorCore doesn't re-render on every keystroke

If any criterion fails, describe the issue.
  </how-to-verify>
  <resume-signal>
Type "approved" if all criteria pass.
If issues found, describe them and I'll create fix tasks.
  </resume-signal>
</task>

</tasks>

<verification>
All verification is in Task 3 (human checkpoint).

If checkpoint passes, Phase 1 is complete and ready for Phase 2: File Management.
</verification>

<success_criteria>
All 5 Phase 1 success criteria from ROADMAP verified by human tester:
1. Type and see text without lag in infinite-scroll canvas
2. Apply formatting via toolbar and shortcuts
3. Click anywhere in empty space, cursor appears there
4. Resize window, content reflows responsively
5. Undo/redo with full history preservation
</success_criteria>

<output>
After completion (checkpoint approved), create `.planning/phases/01-editor-foundation/01-04-SUMMARY.md`
</output>
