---
phase: 07-layout-and-numbering
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/ParagraphNumbers/ParagraphNumbers.ts
  - src/extensions/ParagraphNumbers/presets.ts
  - src/extensions/ParagraphNumbers/index.ts
  - src/styles/paragraph-numbers.css
  - src/stores/editorStore.ts
  - src/components/Editor/EditorCore.tsx
  - src/components/Editor/CanvasContextMenu.tsx
  - src/components/Editor/ParagraphNumberPicker.tsx
autonomous: true

must_haves:
  truths:
    - "User can apply paragraph numbering preset via context menu"
    - "All block types get numbered (paragraphs, headings, lists, callouts)"
    - "Sequential presets number 1, 2, 3 or a, b, c etc"
    - "Hierarchical presets track heading levels (1.1, 1.2, 2.1)"
    - "Legal presets use Article/Section/Clause format"
  artifacts:
    - path: "src/extensions/ParagraphNumbers/ParagraphNumbers.ts"
      provides: "Widget decoration plugin for numbers"
      exports: ["ParagraphNumbers"]
    - path: "src/extensions/ParagraphNumbers/presets.ts"
      provides: "Numbering preset definitions"
      exports: ["PARAGRAPH_NUMBER_PRESETS"]
    - path: "src/styles/paragraph-numbers.css"
      provides: "Inline number styling"
      contains: ".paragraph-number"
    - path: "src/components/Editor/ParagraphNumberPicker.tsx"
      provides: "Preset picker UI"
      exports: ["ParagraphNumberPicker"]
  key_links:
    - from: "src/extensions/ParagraphNumbers/ParagraphNumbers.ts"
      to: "presets.ts"
      via: "format function from preset"
      pattern: "formatNumber"
    - from: "src/components/Editor/CanvasContextMenu.tsx"
      to: "ParagraphNumberPicker"
      via: "submenu opening picker"
      pattern: "ParagraphNumberPicker"
---

<objective>
Create paragraph numbering system with preset-based formatting and widget decorations.

Purpose: Enable document numbering for legal documents, academic papers, and structured content with various numbering styles.

Output: Preset picker UI, working numbering for all block types, hierarchical tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-layout-and-numbering/07-CONTEXT.md
@src/stores/editorStore.ts
@src/components/Editor/EditorCore.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Numbering Presets and Store Settings</name>
  <files>
    src/extensions/ParagraphNumbers/presets.ts
    src/stores/editorStore.ts
  </files>
  <action>
Define numbering presets and add settings to store:

**presets.ts:**
```typescript
/**
 * Paragraph Numbering Presets
 * All available numbering styles for document paragraphs
 */

export interface NumberingPreset {
  id: string
  name: string
  category: 'sequential' | 'hierarchical' | 'legal'
  preview: string
  formatNumber: (index: number, level?: number, parentNumbers?: number[]) => string
}

// Roman numeral conversion
function toRoman(num: number, lowercase = false): string {
  const romanNumerals: [number, string][] = [
    [1000, 'M'], [900, 'CM'], [500, 'D'], [400, 'CD'],
    [100, 'C'], [90, 'XC'], [50, 'L'], [40, 'XL'],
    [10, 'X'], [9, 'IX'], [5, 'V'], [4, 'IV'], [1, 'I'],
  ]
  let result = ''
  for (const [value, symbol] of romanNumerals) {
    while (num >= value) {
      result += symbol
      num -= value
    }
  }
  return lowercase ? result.toLowerCase() : result
}

// Alpha conversion (a, b, c... aa, ab...)
function toAlpha(num: number, uppercase = false): string {
  let result = ''
  while (num > 0) {
    num--
    result = String.fromCharCode(97 + (num % 26)) + result
    num = Math.floor(num / 26)
  }
  return uppercase ? result.toUpperCase() : result
}

export const PARAGRAPH_NUMBER_PRESETS: NumberingPreset[] = [
  // === SEQUENTIAL STYLES ===
  {
    id: 'seq-numeric',
    name: 'Numbers (1, 2, 3)',
    category: 'sequential',
    preview: '1.\n2.\n3.',
    formatNumber: (index) => `${index}.`,
  },
  {
    id: 'seq-roman',
    name: 'Roman (I, II, III)',
    category: 'sequential',
    preview: 'I.\nII.\nIII.',
    formatNumber: (index) => `${toRoman(index)}.`,
  },
  {
    id: 'seq-roman-lower',
    name: 'Roman lowercase (i, ii, iii)',
    category: 'sequential',
    preview: 'i.\nii.\niii.',
    formatNumber: (index) => `${toRoman(index, true)}.`,
  },
  {
    id: 'seq-alpha',
    name: 'Letters (a, b, c)',
    category: 'sequential',
    preview: 'a.\nb.\nc.',
    formatNumber: (index) => `${toAlpha(index)}.`,
  },
  {
    id: 'seq-alpha-upper',
    name: 'Letters uppercase (A, B, C)',
    category: 'sequential',
    preview: 'A.\nB.\nC.',
    formatNumber: (index) => `${toAlpha(index, true)}.`,
  },
  {
    id: 'seq-hex',
    name: 'Hexadecimal (0x1, 0x2)',
    category: 'sequential',
    preview: '0x1\n0x2\n0x3',
    formatNumber: (index) => `0x${index.toString(16).toUpperCase()}`,
  },

  // === HIERARCHICAL STYLES ===
  {
    id: 'hier-numeric',
    name: 'Hierarchical (1, 1.1, 1.2)',
    category: 'hierarchical',
    preview: '1.\n  1.1\n  1.2\n2.',
    formatNumber: (index, level = 0, parents = []) => {
      const numbers = [...parents, index]
      return numbers.join('.') + (level === 0 ? '.' : '')
    },
  },
  {
    id: 'hier-roman',
    name: 'Hierarchical Roman (I, I.i)',
    category: 'hierarchical',
    preview: 'I.\n  I.i\n  I.ii\nII.',
    formatNumber: (index, level = 0, parents = []) => {
      const formatted = [...parents, index].map((n, i) =>
        i === 0 ? toRoman(n) : toRoman(n, true)
      )
      return formatted.join('.') + (level === 0 ? '.' : '')
    },
  },
  {
    id: 'hier-alpha',
    name: 'Hierarchical Letters (A, A.a)',
    category: 'hierarchical',
    preview: 'A.\n  A.a\n  A.b\nB.',
    formatNumber: (index, level = 0, parents = []) => {
      const formatted = [...parents, index].map((n, i) =>
        i === 0 ? toAlpha(n, true) : toAlpha(n)
      )
      return formatted.join('.') + (level === 0 ? '.' : '')
    },
  },

  // === LEGAL MULTI-LEVEL ===
  {
    id: 'legal-standard',
    name: 'Legal Standard',
    category: 'legal',
    preview: 'Article 1\n  Section 1.1\n    Clause 1.1.1',
    formatNumber: (index, level = 0, parents = []) => {
      const numbers = [...parents, index].join('.')
      const prefixes = ['Article', 'Section', 'Clause', 'Subclause']
      const prefix = prefixes[level] || 'Para'
      return `${prefix} ${numbers}`
    },
  },
  {
    id: 'legal-outline',
    name: 'Legal Outline',
    category: 'legal',
    preview: 'I.\n  A.\n    1.\n      a)',
    formatNumber: (index, level = 0) => {
      const formats = [
        () => `${toRoman(index)}.`,
        () => `${toAlpha(index, true)}.`,
        () => `${index}.`,
        () => `${toAlpha(index)})`,
        () => `(${index})`,
        () => `(${toAlpha(index)})`,
      ]
      return (formats[level] || formats[formats.length - 1])()
    },
  },
  {
    id: 'legal-contract',
    name: 'Contract Style',
    category: 'legal',
    preview: '1.\n  1.1\n    1.1.1\n      (a)',
    formatNumber: (index, level = 0, parents = []) => {
      if (level < 3) {
        const numbers = [...parents, index].join('.')
        return level === 0 ? `${numbers}.` : numbers
      }
      return `(${toAlpha(index)})`
    },
  },
]

export function getPresetById(id: string): NumberingPreset | undefined {
  return PARAGRAPH_NUMBER_PRESETS.find((p) => p.id === id)
}

export function getPresetsByCategory(category: string): NumberingPreset[] {
  return PARAGRAPH_NUMBER_PRESETS.filter((p) => p.category === category)
}
```

**Update editorStore.ts:**
Add paragraph numbering settings:
```typescript
interface EditorState {
  // ... existing fields

  // Paragraph Numbering settings
  paragraphNumbers: {
    enabled: boolean
    presetId: string | null // null = off, string = preset ID
  }

  // Actions
  setParagraphNumbers: (settings: Partial<EditorState['paragraphNumbers']>) => void
  toggleParagraphNumbers: () => void
}

// Implementation:
paragraphNumbers: {
  enabled: false,
  presetId: null,
},

setParagraphNumbers: (settings) =>
  set((state) => ({
    paragraphNumbers: { ...state.paragraphNumbers, ...settings },
  })),

toggleParagraphNumbers: () =>
  set((state) => ({
    paragraphNumbers: {
      ...state.paragraphNumbers,
      enabled: !state.paragraphNumbers.enabled,
      presetId: state.paragraphNumbers.enabled ? null : 'seq-numeric',
    },
  })),
```

CRITICAL: Presets have formatNumber function that takes index, level, and parent numbers.
CRITICAL: Hierarchical presets need to track heading levels for proper numbering.
  </action>
  <verify>
TypeScript compiles: `npm run build 2>&1 | head -30`
  </verify>
  <done>Numbering presets defined and store settings added</done>
</task>

<task type="auto">
  <name>Task 2: Create ParagraphNumbers Extension</name>
  <files>
    src/extensions/ParagraphNumbers/ParagraphNumbers.ts
    src/extensions/ParagraphNumbers/index.ts
    src/styles/paragraph-numbers.css
  </files>
  <action>
Create the paragraph numbering extension using widget decorations:

**ParagraphNumbers.ts:**
```typescript
import { Extension } from '@tiptap/core'
import { Plugin, PluginKey } from '@tiptap/pm/state'
import { Decoration, DecorationSet } from '@tiptap/pm/view'
import { getPresetById, type NumberingPreset } from './presets'

export interface ParagraphNumbersOptions {
  getSettings: () => {
    enabled: boolean
    presetId: string | null
  }
}

export const paragraphNumbersPluginKey = new PluginKey('paragraphNumbers')

export const ParagraphNumbers = Extension.create<ParagraphNumbersOptions>({
  name: 'paragraphNumbers',

  addOptions() {
    return {
      getSettings: () => ({ enabled: false, presetId: null }),
    }
  },

  addProseMirrorPlugins() {
    const getSettings = this.options.getSettings

    return [
      new Plugin({
        key: paragraphNumbersPluginKey,

        props: {
          decorations(state) {
            const settings = getSettings()

            if (!settings.enabled || !settings.presetId) {
              return DecorationSet.empty
            }

            const preset = getPresetById(settings.presetId)
            if (!preset) return DecorationSet.empty

            const decorations: Decoration[] = []
            const { doc } = state

            // Track numbering state
            let sequentialIndex = 0
            const hierarchyStack: number[] = [] // Track heading levels
            let currentLevel = 0

            doc.descendants((node, pos) => {
              // Skip non-block nodes
              if (!node.isBlock) return true

              // Skip columnSection and column (containers, not content)
              if (node.type.name === 'columnSection' || node.type.name === 'column') {
                return true
              }

              // Handle numbered block types
              const isNumberable = [
                'paragraph',
                'heading',
                'blockquote',
                'codeBlock',
                'callout',
                'listItem',
              ].includes(node.type.name)

              if (!isNumberable) return true

              sequentialIndex++

              // For hierarchical presets, track heading levels
              if (preset.category === 'hierarchical' || preset.category === 'legal') {
                if (node.type.name === 'heading') {
                  const level = node.attrs.level || 1
                  // Reset sub-levels when we go up
                  while (hierarchyStack.length >= level) {
                    hierarchyStack.pop()
                  }
                  // Increment or start counter at this level
                  if (hierarchyStack.length === level - 1) {
                    hierarchyStack.push(1)
                  } else {
                    hierarchyStack[hierarchyStack.length - 1]++
                  }
                  currentLevel = level - 1
                } else {
                  // Non-heading content gets numbered under current heading
                  currentLevel = hierarchyStack.length
                }
              }

              // Format the number
              let numberText: string
              if (preset.category === 'sequential') {
                numberText = preset.formatNumber(sequentialIndex)
              } else {
                const parentNumbers = hierarchyStack.slice(0, -1)
                const currentIndex = hierarchyStack[hierarchyStack.length - 1] || sequentialIndex
                numberText = preset.formatNumber(currentIndex, currentLevel, parentNumbers)
              }

              // Create widget decoration
              const widget = Decoration.widget(
                pos + 1, // Position at start of node content
                () => {
                  const span = document.createElement('span')
                  span.className = 'paragraph-number'
                  span.setAttribute('data-level', String(currentLevel))
                  span.textContent = numberText + ' '
                  span.contentEditable = 'false'
                  return span
                },
                { side: -1 } // Insert before content
              )

              decorations.push(widget)
              return true
            })

            return DecorationSet.create(doc, decorations)
          },
        },
      }),
    ]
  },
})

export default ParagraphNumbers
```

**index.ts:**
```typescript
export { ParagraphNumbers, paragraphNumbersPluginKey } from './ParagraphNumbers'
export { PARAGRAPH_NUMBER_PRESETS, getPresetById, getPresetsByCategory } from './presets'
export type { NumberingPreset } from './presets'
```

**paragraph-numbers.css:**
```css
/* Paragraph Number Widget */
.paragraph-number {
  display: inline;
  font-family: var(--font-mono, 'SF Mono', 'Monaco', 'Menlo', monospace);
  font-size: 0.9em;
  color: var(--color-text-secondary, #6b7280);
  margin-right: 0.5em;
  user-select: none;
  pointer-events: none;
}

/* Indent based on hierarchy level */
.paragraph-number[data-level="1"] { margin-left: 1em; }
.paragraph-number[data-level="2"] { margin-left: 2em; }
.paragraph-number[data-level="3"] { margin-left: 3em; }
.paragraph-number[data-level="4"] { margin-left: 4em; }

/* Legal style formatting */
.paragraph-number:not(:empty) {
  font-weight: 500;
}

/* Hide in focus mode if desired */
.focus-mode .paragraph-number {
  opacity: 0.5;
}
```

**Update editor.css:**
```css
@import './paragraph-numbers.css';
```

CRITICAL: Widget decorations with side: -1 insert BEFORE the node content.
CRITICAL: contentEditable="false" prevents selection/editing of numbers.
CRITICAL: Hierarchical tracking needs proper heading level management.
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. Enable paragraph numbers in store
3. Verify decorations appear before paragraphs
  </verify>
  <done>ParagraphNumbers extension with widget decorations created</done>
</task>

<task type="auto">
  <name>Task 3: Create Preset Picker and Integrate</name>
  <files>
    src/components/Editor/ParagraphNumberPicker.tsx
    src/components/Editor/CanvasContextMenu.tsx
    src/components/Editor/EditorCore.tsx
    src/components/Editor/index.ts
  </files>
  <action>
Create preset picker UI and integrate with canvas context menu:

**ParagraphNumberPicker.tsx:**
```tsx
/**
 * Paragraph Number Preset Picker
 * Grid of preset options with live preview
 */
import { useState } from 'react'
import { PARAGRAPH_NUMBER_PRESETS, type NumberingPreset } from '../../extensions/ParagraphNumbers'
import { useEditorStore } from '../../stores/editorStore'

interface ParagraphNumberPickerProps {
  onClose: () => void
  interfaceColors: {
    bg: string
    bgSurface: string
    border: string
    textPrimary: string
    textSecondary: string
  }
  position: { x: number; y: number }
}

export function ParagraphNumberPicker({ onClose, interfaceColors, position }: ParagraphNumberPickerProps) {
  const [selectedCategory, setSelectedCategory] = useState<string>('sequential')
  const currentPresetId = useEditorStore((s) => s.paragraphNumbers.presetId)
  const setParagraphNumbers = useEditorStore((s) => s.setParagraphNumbers)

  const categories = [
    { id: 'sequential', name: 'Sequential' },
    { id: 'hierarchical', name: 'Hierarchical' },
    { id: 'legal', name: 'Legal' },
  ]

  const filteredPresets = PARAGRAPH_NUMBER_PRESETS.filter(
    (p) => p.category === selectedCategory
  )

  const handleSelectPreset = (preset: NumberingPreset) => {
    setParagraphNumbers({ enabled: true, presetId: preset.id })
    onClose()
  }

  const handleDisable = () => {
    setParagraphNumbers({ enabled: false, presetId: null })
    onClose()
  }

  const pickerStyle: React.CSSProperties = {
    position: 'fixed',
    left: position.x,
    top: position.y,
    backgroundColor: interfaceColors.bg,
    border: `1px solid ${interfaceColors.border}`,
    borderRadius: '8px',
    boxShadow: '0 4px 20px rgba(0, 0, 0, 0.25)',
    padding: '12px',
    zIndex: 1001,
    width: '320px',
    maxHeight: '400px',
    overflow: 'auto',
  }

  const categoryTabStyle = (active: boolean): React.CSSProperties => ({
    padding: '6px 12px',
    borderRadius: '4px',
    fontSize: '13px',
    cursor: 'pointer',
    backgroundColor: active ? interfaceColors.bgSurface : 'transparent',
    color: active ? interfaceColors.textPrimary : interfaceColors.textSecondary,
    border: 'none',
  })

  const presetCardStyle = (selected: boolean): React.CSSProperties => ({
    padding: '12px',
    borderRadius: '6px',
    border: `1px solid ${selected ? '#3b82f6' : interfaceColors.border}`,
    backgroundColor: selected ? 'rgba(59, 130, 246, 0.1)' : interfaceColors.bgSurface,
    cursor: 'pointer',
    marginBottom: '8px',
  })

  return (
    <div style={pickerStyle} onClick={(e) => e.stopPropagation()}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
        <span style={{ fontWeight: 600, color: interfaceColors.textPrimary }}>Paragraph Numbering</span>
        <button
          onClick={handleDisable}
          style={{
            padding: '4px 8px',
            borderRadius: '4px',
            border: `1px solid ${interfaceColors.border}`,
            backgroundColor: 'transparent',
            color: interfaceColors.textSecondary,
            cursor: 'pointer',
            fontSize: '12px',
          }}
        >
          Disable
        </button>
      </div>

      {/* Category Tabs */}
      <div style={{ display: 'flex', gap: '4px', marginBottom: '12px' }}>
        {categories.map((cat) => (
          <button
            key={cat.id}
            style={categoryTabStyle(selectedCategory === cat.id)}
            onClick={() => setSelectedCategory(cat.id)}
          >
            {cat.name}
          </button>
        ))}
      </div>

      {/* Preset Grid */}
      <div>
        {filteredPresets.map((preset) => (
          <div
            key={preset.id}
            style={presetCardStyle(currentPresetId === preset.id)}
            onClick={() => handleSelectPreset(preset)}
          >
            <div style={{ fontWeight: 500, color: interfaceColors.textPrimary, marginBottom: '4px' }}>
              {preset.name}
              {currentPresetId === preset.id && <span style={{ marginLeft: '8px' }}>✓</span>}
            </div>
            <pre
              style={{
                margin: 0,
                fontSize: '12px',
                color: interfaceColors.textSecondary,
                fontFamily: 'var(--font-mono, monospace)',
                whiteSpace: 'pre-wrap',
              }}
            >
              {preset.preview}
            </pre>
          </div>
        ))}
      </div>
    </div>
  )
}
```

**Update CanvasContextMenu.tsx:**
Add paragraph numbering section and picker trigger:
```tsx
import { ParagraphNumberPicker } from './ParagraphNumberPicker'
import { useEditorStore } from '../../stores/editorStore'

// Inside component:
const [showNumberPicker, setShowNumberPicker] = useState(false)
const [pickerPosition, setPickerPosition] = useState({ x: 0, y: 0 })

const paragraphNumbers = useEditorStore((s) => s.paragraphNumbers)

// Add handler:
const handleOpenNumberPicker = useCallback((e: React.MouseEvent) => {
  const rect = (e.target as HTMLElement).getBoundingClientRect()
  setPickerPosition({ x: rect.right + 8, y: rect.top })
  setShowNumberPicker(true)
}, [])

// In the menu JSX, add after Line Numbers section:
<div style={separatorStyle} />

<div style={labelStyle}>Paragraph Numbering</div>

<div
  style={itemStyle}
  onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = interfaceColors.bgSurface)}
  onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = 'transparent')}
  onClick={handleOpenNumberPicker}
>
  <span style={{ width: '16px' }}>{paragraphNumbers.enabled ? '✓' : ''}</span>
  <span>{paragraphNumbers.presetId ? `Active: ${paragraphNumbers.presetId}` : 'Choose Style...'}</span>
  <span style={{ marginLeft: 'auto' }}>→</span>
</div>

// Render picker when open:
{showNumberPicker && (
  <ParagraphNumberPicker
    position={pickerPosition}
    interfaceColors={interfaceColors}
    onClose={() => {
      setShowNumberPicker(false)
      setIsOpen(false)
    }}
  />
)}
```

**Update EditorCore.tsx:**
Add ParagraphNumbers extension:
```typescript
import { ParagraphNumbers } from '../../extensions/ParagraphNumbers'

// In extensions array:
ParagraphNumbers.configure({
  getSettings: () => useEditorStore.getState().paragraphNumbers,
}),
```

**Update index.ts:**
```typescript
export { ParagraphNumberPicker } from './ParagraphNumberPicker'
```

CRITICAL: Picker opens as submenu from context menu item.
CRITICAL: Extension reads settings via getSettings callback.
  </action>
  <verify>
1. Run `npm run dev`
2. Right-click canvas, see "Paragraph Numbering" section
3. Click "Choose Style..." - preset picker opens
4. Select "Numbers (1, 2, 3)" - paragraphs get numbered
5. Add headings, select hierarchical preset - nested numbering works
6. Select legal preset - Article/Section formatting
  </verify>
  <done>Preset picker created and paragraph numbering integrated</done>
</task>

</tasks>

<verification>
1. Right-click canvas, select paragraph numbering style
2. Sequential styles: 1, 2, 3 or a, b, c or i, ii, iii
3. Hierarchical styles track heading levels: 1.1, 1.2, 2.1
4. Legal styles show Article 1, Section 1.1, Clause 1.1.1
5. Numbers appear before all block types (paragraphs, lists, callouts)
6. Numbers update when document structure changes
7. Can disable numbering via picker
8. Build passes: `npm run build`
</verification>

<success_criteria>
- 12 numbering presets (6 sequential, 3 hierarchical, 3 legal)
- Widget decorations insert numbers before content
- Hierarchical tracking respects heading levels
- Preset picker with category tabs
- Numbers styled and non-editable
- Can enable/disable via context menu
</success_criteria>

<output>
After completion, create `.planning/phases/07-layout-and-numbering/07-05-SUMMARY.md`
</output>
