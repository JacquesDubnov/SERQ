---
phase: 07-layout-and-numbering
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - src/styles/editor.css
  - src/extensions/ResizableImage/ResizableImage.ts
  - src/extensions/ResizableImage/ImageView.tsx
  - src/components/Editor/BlockContextMenu.tsx
autonomous: true

must_haves:
  truths:
    - "User sees animated glow indicator when dragging images"
    - "User can enable free positioning mode for images"
    - "Free-positioned images stay within canvas bounds"
    - "Text reflows around positioned images"
  artifacts:
    - path: "src/styles/editor.css"
      provides: "Enhanced drop cursor styling"
      contains: ".ProseMirror-dropcursor"
    - path: "src/extensions/ResizableImage/ResizableImage.ts"
      provides: "Free positioning attributes"
      contains: "freePosition"
    - path: "src/extensions/ResizableImage/ImageView.tsx"
      provides: "Draggable positioning in free mode"
      contains: "position: 'absolute'"
  key_links:
    - from: "src/extensions/ResizableImage/ImageView.tsx"
      to: "freePosition attribute"
      via: "conditional absolute positioning"
      pattern: "freePosition.*absolute"
    - from: "src/components/Editor/BlockContextMenu.tsx"
      to: "Enable Free Positioning toggle"
      via: "menu option"
      pattern: "Free Positioning"
---

<objective>
Enhance image dragging with animated drop indicators and optional free positioning mode.

Purpose: Enable precise image placement with visual feedback during drag operations and absolute positioning for advanced layouts.

Output: Enhanced drop cursor, free positioning toggle, constrained drag within canvas.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-layout-and-numbering/07-CONTEXT.md
@.planning/phases/07-layout-and-numbering/07-02-SUMMARY.md
@src/extensions/ResizableImage/ResizableImage.ts
@src/extensions/ResizableImage/ImageView.tsx
@src/styles/editor.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Drop Cursor Styling</name>
  <files>
    src/styles/editor.css
  </files>
  <action>
Add enhanced drop cursor styling for image drag operations:

**Add to editor.css:**
```css
/* =============================================
   Enhanced Drop Cursor for Image Dragging
   ============================================= */

/* Drop cursor line with glow effect */
.ProseMirror .ProseMirror-dropcursor {
  background: linear-gradient(90deg, transparent, var(--color-accent, #3b82f6), transparent);
  height: 3px;
  box-shadow:
    0 0 8px rgba(59, 130, 246, 0.6),
    0 0 16px rgba(59, 130, 246, 0.4),
    0 0 24px rgba(59, 130, 246, 0.2);
  animation: dropCursorPulse 1.2s ease-in-out infinite;
  border-radius: 2px;
}

@keyframes dropCursorPulse {
  0%, 100% {
    opacity: 1;
    transform: scaleX(1);
  }
  50% {
    opacity: 0.7;
    transform: scaleX(1.02);
  }
}

/* Drop zone highlight when dragging over valid area */
.ProseMirror.dragging-over {
  background-color: rgba(59, 130, 246, 0.02);
}

/* Dragging state on the image itself */
.resizable-image-wrapper.dragging {
  opacity: 0.5;
  transform: scale(0.98);
  transition: opacity 0.15s, transform 0.15s;
}

/* Ghost/preview of dragged image */
.ProseMirror [data-drag-handle] {
  cursor: grab;
}

.ProseMirror [data-drag-handle]:active {
  cursor: grabbing;
}
```

The ProseMirror drop cursor is already rendered by TipTap's Dropcursor extension (part of StarterKit). This CSS enhances its appearance.

CRITICAL: Do NOT add new JS for drop cursor - it's handled by TipTap. We're only styling it.
  </action>
  <verify>
1. Run `npm run dev`
2. Insert an image
3. Drag the image - drop cursor should show with glow effect
4. Drop cursor pulses/animates
  </verify>
  <done>Enhanced drop cursor styling with animation and glow</done>
</task>

<task type="auto">
  <name>Task 2: Add Free Positioning Mode to Images</name>
  <files>
    src/extensions/ResizableImage/ResizableImage.ts
    src/extensions/ResizableImage/ImageView.tsx
  </files>
  <action>
Add free positioning attributes and implement absolute positioning in ImageView:

**Update ResizableImage.ts addAttributes():**
```typescript
addAttributes() {
  return {
    src: { default: null },
    alt: { default: null },
    title: { default: null },
    width: { default: null },
    height: { default: null },
    alignment: { default: 'center' },
    float: {
      default: 'none',
      parseHTML: element => element.getAttribute('data-float') || 'none',
      renderHTML: attributes => ({ 'data-float': attributes.float }),
    },
    // NEW: Free positioning mode
    freePosition: {
      default: false,
      parseHTML: element => element.getAttribute('data-free-position') === 'true',
      renderHTML: attributes => ({
        'data-free-position': attributes.freePosition ? 'true' : 'false',
      }),
    },
    // Position coordinates (percentage of canvas width/height)
    positionX: {
      default: 50,
      parseHTML: element => parseFloat(element.getAttribute('data-position-x') || '50'),
      renderHTML: attributes => ({ 'data-position-x': String(attributes.positionX) }),
    },
    positionY: {
      default: 0,
      parseHTML: element => parseFloat(element.getAttribute('data-position-y') || '0'),
      renderHTML: attributes => ({ 'data-position-y': String(attributes.positionY) }),
    },
  }
}
```

**Update ImageView.tsx:**
Add free positioning drag handling:
```tsx
import { NodeViewWrapper } from '@tiptap/react'
import { useCallback, useState, useRef, useEffect } from 'react'
import type { NodeViewProps } from '@tiptap/react'

export function ImageView({ node, updateAttributes, selected, editor }: NodeViewProps) {
  const { src, alt, title, width, height, alignment, float, freePosition, positionX, positionY } = node.attrs
  const [isDragging, setIsDragging] = useState(false)
  const [isResizing, setIsResizing] = useState(false)
  const wrapperRef = useRef<HTMLDivElement>(null)

  // Handle free position drag
  const handleFreePositionDrag = useCallback((e: React.MouseEvent) => {
    if (!freePosition || isResizing) return

    e.preventDefault()
    setIsDragging(true)

    const startX = e.clientX
    const startY = e.clientY
    const startPosX = positionX
    const startPosY = positionY

    // Get canvas bounds
    const canvas = wrapperRef.current?.closest('.canvas-container') as HTMLElement
    if (!canvas) return

    const canvasRect = canvas.getBoundingClientRect()

    const handleMouseMove = (moveE: MouseEvent) => {
      const deltaX = moveE.clientX - startX
      const deltaY = moveE.clientY - startY

      // Convert to percentage of canvas
      const deltaXPercent = (deltaX / canvasRect.width) * 100
      const deltaYPercent = (deltaY / canvasRect.height) * 100

      // Constrain to canvas bounds (0-100%)
      const newX = Math.max(0, Math.min(100, startPosX + deltaXPercent))
      const newY = Math.max(0, Math.min(100, startPosY + deltaYPercent))

      updateAttributes({ positionX: newX, positionY: newY })
    }

    const handleMouseUp = () => {
      setIsDragging(false)
      document.removeEventListener('mousemove', handleMouseMove)
      document.removeEventListener('mouseup', handleMouseUp)
    }

    document.addEventListener('mousemove', handleMouseMove)
    document.addEventListener('mouseup', handleMouseUp)
  }, [freePosition, isResizing, positionX, positionY, updateAttributes])

  // Determine wrapper styles
  const wrapperStyles: React.CSSProperties = freePosition
    ? {
        position: 'absolute',
        left: `${positionX}%`,
        top: `${positionY}px`,
        transform: 'translateX(-50%)',
        zIndex: 10,
        cursor: isDragging ? 'grabbing' : 'grab',
      }
    : {
        // Normal flow positioning - use float class
      }

  const floatClass = !freePosition ? `block-float-${float || 'none'}` : ''

  return (
    <NodeViewWrapper
      ref={wrapperRef}
      className={`resizable-image-wrapper ${floatClass} ${selected ? 'selected' : ''} ${isDragging ? 'dragging' : ''} ${freePosition ? 'free-positioned' : ''}`}
      style={wrapperStyles}
      onMouseDown={freePosition ? handleFreePositionDrag : undefined}
      data-drag-handle={!freePosition ? '' : undefined}
    >
      <img
        src={src}
        alt={alt || ''}
        title={title || undefined}
        style={{
          width: width ? `${width}px` : 'auto',
          height: height ? `${height}px` : 'auto',
          maxWidth: '100%',
          display: 'block',
          pointerEvents: 'none', // Prevent image drag interference
        }}
        draggable={false}
      />

      {/* Resize handle - SE corner only */}
      {selected && (
        <div
          className="resize-handle resize-handle-se"
          onMouseDown={(e) => {
            e.stopPropagation()
            setIsResizing(true)
            // ... existing resize logic
          }}
        />
      )}
    </NodeViewWrapper>
  )
}
```

**Add to styles (images.css or editor.css):**
```css
/* Free Positioned Image */
.resizable-image-wrapper.free-positioned {
  position: absolute;
  z-index: 10;
}

.resizable-image-wrapper.free-positioned:hover {
  outline: 2px dashed var(--color-accent, #3b82f6);
  outline-offset: 4px;
}

.resizable-image-wrapper.free-positioned.dragging {
  outline: 2px solid var(--color-accent, #3b82f6);
}
```

CRITICAL: Free positioned images need position: absolute on the wrapper.
CRITICAL: Constrain positionX/Y to 0-100% to stay within canvas.
CRITICAL: Keep existing resize handle functionality working.
  </action>
  <verify>
1. Enable free positioning on an image via context menu
2. Drag image to different position - should move freely
3. Position should be constrained to canvas bounds
4. Resize handle should still work in free position mode
  </verify>
  <done>Free positioning mode implemented with constrained drag</done>
</task>

<task type="auto">
  <name>Task 3: Add Free Positioning Toggle to Block Context Menu</name>
  <files>
    src/components/Editor/BlockContextMenu.tsx
  </files>
  <action>
Add "Enable Free Positioning" toggle to the BlockContextMenu:

**Update BlockContextMenu.tsx:**

Add state for free positioning:
```typescript
const [isFreePositioned, setIsFreePositioned] = useState(false)

// In handleContextMenu, also read free position state:
const freePos = imageWrapper?.getAttribute('data-free-position') === 'true'
setIsFreePositioned(freePos)
```

Add toggle handler:
```typescript
const handleToggleFreePosition = useCallback(() => {
  if (!editor || targetNodeType !== 'image') return

  editor.chain().focus().updateAttributes('image', {
    freePosition: !isFreePositioned,
    // Reset position when enabling
    positionX: isFreePositioned ? 50 : 50,
    positionY: isFreePositioned ? 0 : 0,
    // Clear float when enabling free position
    float: isFreePositioned ? 'none' : 'none',
  }).run()

  setIsOpen(false)
}, [editor, targetNodeType, isFreePositioned])
```

Add menu item after float options (only show for images):
```tsx
{targetNodeType === 'image' && (
  <>
    <div style={separatorStyle} />

    <div
      style={{
        ...itemStyle,
        backgroundColor: isFreePositioned ? interfaceColors.bgSurface : 'transparent',
      }}
      onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = interfaceColors.bgSurface)}
      onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = isFreePositioned ? interfaceColors.bgSurface : 'transparent')}
      onClick={handleToggleFreePosition}
    >
      <span style={{ width: '20px', textAlign: 'center' }}>{isFreePositioned ? 'âœ“' : ''}</span>
      <span>Free Positioning</span>
    </div>
  </>
)}
```

CRITICAL: Free positioning is only available for images, not callouts.
CRITICAL: Enabling free positioning should clear float (they're mutually exclusive).
  </action>
  <verify>
1. Insert image, right-click
2. Menu shows "Free Positioning" option
3. Enable it - image becomes absolutely positioned
4. Drag image - moves freely within canvas
5. Disable it - image returns to document flow
  </verify>
  <done>Free positioning toggle added to block context menu</done>
</task>

</tasks>

<verification>
1. Drag image in normal mode - see animated glow drop cursor
2. Right-click image, enable "Free Positioning"
3. Drag image - moves to any position within canvas
4. Image can't be dragged outside canvas bounds
5. Disable free positioning - image returns to flow
6. Float options still work in normal mode
7. Build passes: `npm run build`
</verification>

<success_criteria>
- Drop cursor has animated glow effect
- Free positioning toggle available in context menu
- Images in free mode can be dragged anywhere
- Position constrained to canvas bounds
- Float and free position are mutually exclusive
- Normal drag/drop still works for flow positioning
</success_criteria>

<output>
After completion, create `.planning/phases/07-layout-and-numbering/07-03-SUMMARY.md`
</output>
