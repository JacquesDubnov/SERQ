---
phase: 07-layout-and-numbering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/extensions/Columns/ColumnSection.ts
  - src/extensions/Columns/Column.ts
  - src/extensions/Columns/ColumnsView.tsx
  - src/extensions/Columns/index.ts
  - src/styles/columns.css
  - src/extensions/SlashCommands/commands.ts
  - src/components/CommandPalette/commands.ts
autonomous: true

must_haves:
  truths:
    - "User can insert 2-6 column layouts via slash command"
    - "User can drag column borders to resize widths"
    - "Columns visually render as grid layout"
    - "Any block type can be placed inside columns"
  artifacts:
    - path: "src/extensions/Columns/ColumnSection.ts"
      provides: "Parent node for column layouts"
      exports: ["ColumnSection"]
    - path: "src/extensions/Columns/Column.ts"
      provides: "Individual column node"
      exports: ["Column"]
    - path: "src/extensions/Columns/ColumnsView.tsx"
      provides: "React NodeView with resize handles"
      exports: ["ColumnsView"]
    - path: "src/styles/columns.css"
      provides: "CSS Grid styling for columns"
      contains: ".column-section"
  key_links:
    - from: "src/extensions/Columns/ColumnSection.ts"
      to: "ColumnsView.tsx"
      via: "ReactNodeViewRenderer"
      pattern: "ReactNodeViewRenderer\\(ColumnsView\\)"
    - from: "src/extensions/SlashCommands/commands.ts"
      to: "insertColumns command"
      via: "editor.chain().insertColumns"
      pattern: "insertColumns"
---

<objective>
Create multi-column layout extension with CSS Grid, draggable resize handles, and column management commands.

Purpose: Enable professional document layouts with independent column content sections that can contain any block type.

Output: Working column insertion via slash commands with visual resize handles.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-layout-and-numbering/07-CONTEXT.md
@src/extensions/Callout/Callout.ts
@src/extensions/Callout/CalloutView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Column and ColumnSection Extensions</name>
  <files>
    src/extensions/Columns/ColumnSection.ts
    src/extensions/Columns/Column.ts
    src/extensions/Columns/index.ts
  </files>
  <action>
Create the multi-column extension following the Callout pattern:

**Column.ts (child node):**
```typescript
import { Node, mergeAttributes } from '@tiptap/core'

export const Column = Node.create({
  name: 'column',
  content: 'block+',
  isolating: true,

  // Priority > 100 per research constraints
  priority: 110,

  parseHTML() {
    return [{ tag: 'div[data-column]' }]
  },

  renderHTML({ HTMLAttributes }) {
    return ['div', mergeAttributes({ 'data-column': '' }, HTMLAttributes), 0]
  },
})
```

**ColumnSection.ts (parent node):**
```typescript
import { Node, mergeAttributes } from '@tiptap/core'
import { ReactNodeViewRenderer } from '@tiptap/react'
import { ColumnsView } from './ColumnsView'

declare module '@tiptap/core' {
  interface Commands<ReturnType> {
    columnSection: {
      insertColumns: (options: { count: number }) => ReturnType
      setColumnCount: (count: number) => ReturnType
      setColumnWidths: (widths: number[]) => ReturnType
      toggleColumnBorders: () => ReturnType
      removeColumns: () => ReturnType
    }
  }
}

export const ColumnSection = Node.create({
  name: 'columnSection',
  group: 'block',
  content: 'column+',
  draggable: true,
  isolating: true,
  priority: 110,

  addAttributes() {
    return {
      columnCount: { default: 2 },
      columnWidths: { default: null }, // null = equal widths, array = fr values
      showBorders: { default: false },
      gap: { default: '24px' },
    }
  },

  parseHTML() {
    return [{ tag: 'div[data-column-section]' }]
  },

  renderHTML({ HTMLAttributes }) {
    return ['div', mergeAttributes({ 'data-column-section': '' }, HTMLAttributes), 0]
  },

  addNodeView() {
    return ReactNodeViewRenderer(ColumnsView)
  },

  addCommands() {
    return {
      insertColumns: ({ count }) => ({ chain }) => {
        const columns = Array(count).fill(null).map(() => ({
          type: 'column',
          content: [{ type: 'paragraph' }],
        }))
        return chain().insertContent({
          type: 'columnSection',
          attrs: { columnCount: count },
          content: columns,
        }).run()
      },

      setColumnCount: (count) => ({ tr, state }) => {
        // Implementation for changing column count
        // ... add/remove columns as needed
        return true
      },

      setColumnWidths: (widths) => ({ commands }) => {
        return commands.updateAttributes('columnSection', { columnWidths: widths })
      },

      toggleColumnBorders: () => ({ commands }) => {
        // Toggle showBorders attribute
        return true
      },

      removeColumns: () => ({ chain }) => {
        // Extract column content as sequential paragraphs
        return chain().deleteNode('columnSection').run()
      },
    }
  },
})
```

**index.ts:**
```typescript
export { ColumnSection } from './ColumnSection'
export { Column } from './Column'
```

CRITICAL: Set priority > 100 to avoid TipTap extension conflicts.
CRITICAL: Column content is 'block+' to allow any block type inside.
CRITICAL: ColumnSection content is 'column+' (not 'block+') to enforce structure.
  </action>
  <verify>
TypeScript compiles without errors: `cd /Users/jacquesdubnov/Coding/serq && npm run build 2>&1 | head -50`
  </verify>
  <done>ColumnSection and Column nodes created with proper hierarchy, attributes, and command interface</done>
</task>

<task type="auto">
  <name>Task 2: Create ColumnsView with Resize Handles</name>
  <files>
    src/extensions/Columns/ColumnsView.tsx
    src/styles/columns.css
  </files>
  <action>
Create the React NodeView for column rendering with CSS Grid and resize handles:

**ColumnsView.tsx:**
```tsx
import { NodeViewWrapper, NodeViewContent } from '@tiptap/react'
import { useCallback, useState, useRef } from 'react'
import type { NodeViewProps } from '@tiptap/react'

export function ColumnsView({ node, updateAttributes, selected }: NodeViewProps) {
  const { columnCount, columnWidths, showBorders, gap } = node.attrs
  const [resizing, setResizing] = useState<number | null>(null)
  const containerRef = useRef<HTMLDivElement>(null)

  // Calculate grid-template-columns
  const getGridColumns = () => {
    if (columnWidths && columnWidths.length === columnCount) {
      return columnWidths.map((w: number) => `${w}fr`).join(' ')
    }
    return `repeat(${columnCount}, 1fr)`
  }

  // Resize handle drag handler
  const handleResizeStart = useCallback((index: number) => (e: React.MouseEvent) => {
    e.preventDefault()
    setResizing(index)

    const startX = e.clientX
    const container = containerRef.current
    if (!container) return

    const containerWidth = container.offsetWidth
    const currentWidths = columnWidths || Array(columnCount).fill(1)

    const handleMouseMove = (moveE: MouseEvent) => {
      const deltaX = moveE.clientX - startX
      const deltaFr = (deltaX / containerWidth) * columnCount

      const newWidths = [...currentWidths]
      newWidths[index] = Math.max(0.5, currentWidths[index] + deltaFr)
      newWidths[index + 1] = Math.max(0.5, currentWidths[index + 1] - deltaFr)

      updateAttributes({ columnWidths: newWidths })
    }

    const handleMouseUp = () => {
      setResizing(null)
      document.removeEventListener('mousemove', handleMouseMove)
      document.removeEventListener('mouseup', handleMouseUp)
    }

    document.addEventListener('mousemove', handleMouseMove)
    document.addEventListener('mouseup', handleMouseUp)
  }, [columnCount, columnWidths, updateAttributes])

  return (
    <NodeViewWrapper
      ref={containerRef}
      className={`column-section ${selected ? 'selected' : ''} ${showBorders ? 'show-borders' : ''}`}
      style={{
        display: 'grid',
        gridTemplateColumns: getGridColumns(),
        gap: gap,
      }}
    >
      <NodeViewContent className="columns-content" />

      {/* Resize handles between columns */}
      {Array.from({ length: columnCount - 1 }).map((_, index) => (
        <div
          key={`resize-${index}`}
          className={`column-resize-handle ${resizing === index ? 'resizing' : ''}`}
          style={{
            gridColumn: `${index + 2}`,
            gridRow: '1 / -1',
          }}
          onMouseDown={handleResizeStart(index)}
        />
      ))}
    </NodeViewWrapper>
  )
}
```

**columns.css:**
```css
/* Column Section Container */
.column-section {
  position: relative;
  margin: 1rem 0;
  min-height: 100px;
}

.column-section.selected {
  outline: 2px solid var(--color-accent, #3b82f6);
  outline-offset: 4px;
  border-radius: 4px;
}

.column-section.show-borders [data-column] {
  border-right: 1px solid var(--color-border, #e5e7eb);
}

.column-section.show-borders [data-column]:last-child {
  border-right: none;
}

/* Individual Column */
[data-column] {
  min-height: 50px;
  padding: 0.5rem;
}

/* Resize Handle */
.column-resize-handle {
  position: absolute;
  width: 8px;
  margin-left: -4px;
  cursor: col-resize;
  background: transparent;
  z-index: 10;
  top: 0;
  bottom: 0;
}

.column-resize-handle:hover,
.column-resize-handle.resizing {
  background: var(--color-accent, #3b82f6);
  opacity: 0.3;
}

/* Columns content wrapper */
.columns-content {
  display: contents; /* Let children participate in parent grid */
}
```

Import the CSS in src/styles/editor.css: `@import './columns.css';`

CRITICAL: Use `display: contents` on NodeViewContent to let columns participate in the grid.
CRITICAL: Resize handles must be positioned absolutely within the grid.
  </action>
  <verify>
Visual verification: Insert columns via `/columns` in the editor, resize handles appear between columns.
Run `npm run dev` and test column insertion.
  </verify>
  <done>ColumnsView renders CSS Grid layout with functional resize handles</done>
</task>

<task type="auto">
  <name>Task 3: Add Column Commands and Integration</name>
  <files>
    src/extensions/SlashCommands/commands.ts
    src/components/CommandPalette/commands.ts
    src/components/Editor/EditorCore.tsx
  </files>
  <action>
Integrate column extension into the editor and add commands:

**Update EditorCore.tsx:**
Add imports and register extensions:
```typescript
import { ColumnSection, Column } from '../../extensions/Columns'

// In extensions array:
ColumnSection,
Column,
```

**Update SlashCommands/commands.ts:**
Add column commands to the 'insert' group:
```typescript
{
  title: '2 Columns',
  description: 'Insert 2-column layout',
  icon: '||',
  group: 'insert',
  aliases: ['columns', '2col', 'twocolumn'],
  command: ({ editor, range }) => {
    editor.chain().focus().deleteRange(range).insertColumns({ count: 2 }).run()
  },
},
{
  title: '3 Columns',
  description: 'Insert 3-column layout',
  icon: '|||',
  group: 'insert',
  aliases: ['3columns', '3col', 'threecolumn'],
  command: ({ editor, range }) => {
    editor.chain().focus().deleteRange(range).insertColumns({ count: 3 }).run()
  },
},
{
  title: '4 Columns',
  description: 'Insert 4-column layout',
  icon: '||||',
  group: 'insert',
  aliases: ['4columns', '4col'],
  command: ({ editor, range }) => {
    editor.chain().focus().deleteRange(range).insertColumns({ count: 4 }).run()
  },
},
```

**Update CommandPalette/commands.ts:**
Add insert commands:
```typescript
{
  id: 'insert-2-columns',
  title: 'Insert 2 Columns',
  group: 'insert',
  action: (editor) => editor.chain().focus().insertColumns({ count: 2 }).run(),
},
{
  id: 'insert-3-columns',
  title: 'Insert 3 Columns',
  group: 'insert',
  action: (editor) => editor.chain().focus().insertColumns({ count: 3 }).run(),
},
```

CRITICAL: Import CSS in editor.css for styles to apply.
  </action>
  <verify>
1. Run `npm run dev`
2. Open app and type `/2col` - should show 2 Columns option
3. Select it - should insert 2-column layout
4. Resize handles appear between columns
5. Content can be typed in each column independently
  </verify>
  <done>Columns fully integrated with slash commands, command palette, and working resize handles</done>
</task>

</tasks>

<verification>
1. Type `/columns` or `/2col` to insert columns
2. Columns render as CSS Grid with equal widths
3. Drag resize handles between columns to adjust widths
4. Type in each column independently
5. Any block type (lists, code, callouts) can be inserted inside columns
6. Build completes without TypeScript errors
</verification>

<success_criteria>
- ColumnSection and Column extensions registered in editor
- CSS Grid layout with gap between columns
- Resize handles functional with visual feedback
- Slash commands and command palette integration
- Build passes: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/07-layout-and-numbering/07-01-SUMMARY.md`
</output>
