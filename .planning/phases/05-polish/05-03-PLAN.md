---
phase: 05-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useFocusMode.ts
  - src/extensions/TypewriterMode.ts
  - src/components/StatusBar/StatusBar.tsx
  - src/styles/focus-mode.css
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "User can toggle focus mode with Cmd+Shift+F (UI-02: Focus mode)"
    - "Focus mode hides all UI chrome (toolbar, panels, status bar)"
    - "User can enable typewriter mode to keep cursor centered (UI-03: Typewriter mode - distinct from focus mode)"
    - "User can combine focus + typewriter for distraction-free writing (UI-05: Distraction-free = Focus + Typewriter combined)"
    - "Status bar shows accurate word count within +/-1 of actual words"
    - "Status bar shows accurate character count matching editor.storage.characterCount"
    - "Status bar shows correct cursor position (Ln, Col)"
  artifacts:
    - path: "src/hooks/useFocusMode.ts"
      provides: "Focus mode state and keyboard shortcut"
      exports: ["useFocusMode"]
    - path: "src/extensions/TypewriterMode.ts"
      provides: "ProseMirror plugin for centered cursor"
      exports: ["TypewriterMode"]
    - path: "src/components/StatusBar/StatusBar.tsx"
      provides: "Bottom status bar with document stats"
      min_lines: 50
    - path: "src/styles/focus-mode.css"
      provides: "CSS for focus mode chrome hiding"
      contains: ".focus-mode"
  key_links:
    - from: "src/hooks/useFocusMode.ts"
      to: "react-hotkeys-hook"
      via: "useHotkeys import"
      pattern: "useHotkeys.*mod\\+shift\\+f"
  notes:
    - "UI-02 (Focus mode) = hide all chrome via Cmd+Shift+F"
    - "UI-03 (Typewriter mode) = keep cursor centered, separate toggle"
    - "UI-05 (Distraction-free) = Focus + Typewriter combined - user enables both"
---

<objective>
Create distraction-free writing features: focus mode, typewriter mode, and status bar.

Purpose: Writers need ability to minimize distractions and track progress. Focus mode hides all UI chrome, typewriter mode keeps cursor centered while typing, status bar provides at-a-glance document statistics.

Note on UI requirements:
- UI-02 (Focus mode): Toggle with Cmd+Shift+F, hides chrome
- UI-03 (Typewriter mode): Optional toggle, keeps cursor vertically centered
- UI-05 (Distraction-free): The combination of Focus + Typewriter enabled together

Output:
- Focus mode hook with Cmd+Shift+F shortcut
- Typewriter mode TipTap extension
- Status bar component with word/char count
- CSS for focus mode visual treatment
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-polish/05-RESEARCH.md

# Existing patterns
@src/hooks/useKeyboardShortcuts.ts
@src/stores/editorStore.ts
@src/extensions/Callout/Callout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create focus mode hook and CSS</name>
  <files>
    src/hooks/useFocusMode.ts
    src/styles/focus-mode.css
    src/hooks/index.ts
  </files>
  <action>
1. Create `src/hooks/useFocusMode.ts`:

```typescript
/**
 * Focus Mode Hook
 * Toggles distraction-free writing mode that hides all UI chrome
 */
import { useState, useCallback, useEffect } from 'react';
import { useHotkeys } from 'react-hotkeys-hook';

interface UseFocusModeReturn {
  /** Whether focus mode is currently active */
  isFocusMode: boolean;
  /** Toggle focus mode on/off */
  toggleFocusMode: () => void;
  /** Explicitly set focus mode state */
  setFocusMode: (enabled: boolean) => void;
}

export function useFocusMode(): UseFocusModeReturn {
  const [isFocusMode, setIsFocusMode] = useState(false);

  const toggleFocusMode = useCallback(() => {
    setIsFocusMode((prev) => !prev);
  }, []);

  const setFocusMode = useCallback((enabled: boolean) => {
    setIsFocusMode(enabled);
  }, []);

  // Register Cmd+Shift+F shortcut
  useHotkeys(
    'mod+shift+f',
    (e) => {
      e.preventDefault();
      toggleFocusMode();
    },
    {
      enableOnContentEditable: true,
      enableOnFormTags: true,
    },
    [toggleFocusMode]
  );

  // Also allow Escape to exit focus mode
  useHotkeys(
    'escape',
    () => {
      if (isFocusMode) {
        setIsFocusMode(false);
      }
    },
    {
      enableOnContentEditable: true,
      enabled: isFocusMode,
    },
    [isFocusMode]
  );

  // Apply/remove focus-mode class on body
  useEffect(() => {
    if (isFocusMode) {
      document.body.classList.add('focus-mode');
    } else {
      document.body.classList.remove('focus-mode');
    }

    return () => {
      document.body.classList.remove('focus-mode');
    };
  }, [isFocusMode]);

  return {
    isFocusMode,
    toggleFocusMode,
    setFocusMode,
  };
}
```

2. Create `src/styles/focus-mode.css`:

```css
/**
 * Focus Mode Styles
 * Hides all UI chrome for distraction-free writing
 */

/* Focus mode active state */
body.focus-mode {
  /* Smooth transition into focus mode */
  transition: background-color 0.3s ease;
}

body.focus-mode .editor-toolbar,
body.focus-mode .toolbar-wrapper,
body.focus-mode .status-bar,
body.focus-mode .outline-panel,
body.focus-mode .style-panel,
body.focus-mode .format-painter-button,
body.focus-mode .export-menu,
body.focus-mode [data-toolbar] {
  display: none !important;
}

/* Full viewport editor */
body.focus-mode .editor-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
  padding: 0;
  margin: 0;
}

/* Center and constrain content */
body.focus-mode .ProseMirror {
  max-width: 700px;
  margin: 0 auto;
  padding: 15vh 2rem 30vh 2rem;
  min-height: 100vh;
}

/* Show exit hint on hover at top */
body.focus-mode::before {
  content: 'Press Cmd+Shift+F or Esc to exit focus mode';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  text-align: center;
  padding: 8px;
  font-size: 12px;
  color: var(--color-text-muted, #888);
  background: linear-gradient(
    to bottom,
    var(--canvas-bg, white) 0%,
    transparent 100%
  );
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  z-index: 1001;
}

body.focus-mode:hover::before {
  opacity: 1;
}

/* Fade effect for focus mode transitions */
@keyframes focus-mode-fade-in {
  from {
    opacity: 0.8;
  }
  to {
    opacity: 1;
  }
}

body.focus-mode .editor-wrapper {
  animation: focus-mode-fade-in 0.3s ease;
}
```

3. Update `src/hooks/index.ts` to export the new hook:
   Add: `export { useFocusMode } from './useFocusMode'`
  </action>
  <verify>
    Run `npm run build` - TypeScript compiles without errors
  </verify>
  <done>
    useFocusMode hook created with Cmd+Shift+F and Escape shortcuts, CSS hides all UI chrome
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypewriterMode extension</name>
  <files>
    src/extensions/TypewriterMode.ts
  </files>
  <action>
1. Create `src/extensions/TypewriterMode.ts`:

```typescript
/**
 * Typewriter Mode Extension
 * Keeps cursor vertically centered while typing
 * Optional feature that can be enabled/disabled
 */
import { Extension } from '@tiptap/core';
import { Plugin, PluginKey } from '@tiptap/pm/state';

export interface TypewriterModeOptions {
  /** Whether typewriter mode is enabled */
  enabled: boolean;
}

declare module '@tiptap/core' {
  interface Commands<ReturnType> {
    typewriterMode: {
      /**
       * Enable typewriter mode
       */
      enableTypewriterMode: () => ReturnType;
      /**
       * Disable typewriter mode
       */
      disableTypewriterMode: () => ReturnType;
      /**
       * Toggle typewriter mode
       */
      toggleTypewriterMode: () => ReturnType;
    };
  }
}

const typewriterPluginKey = new PluginKey('typewriterMode');

export const TypewriterMode = Extension.create<TypewriterModeOptions>({
  name: 'typewriterMode',

  addOptions() {
    return {
      enabled: false,
    };
  },

  addStorage() {
    return {
      enabled: this.options.enabled,
    };
  },

  addCommands() {
    return {
      enableTypewriterMode:
        () =>
        ({ editor }) => {
          editor.storage.typewriterMode.enabled = true;
          return true;
        },

      disableTypewriterMode:
        () =>
        ({ editor }) => {
          editor.storage.typewriterMode.enabled = false;
          return true;
        },

      toggleTypewriterMode:
        () =>
        ({ editor }) => {
          editor.storage.typewriterMode.enabled =
            !editor.storage.typewriterMode.enabled;
          return true;
        },
    };
  },

  addProseMirrorPlugins() {
    const extension = this;

    return [
      new Plugin({
        key: typewriterPluginKey,

        view() {
          return {
            update(view, prevState) {
              // Check if typewriter mode is enabled
              if (!extension.storage.enabled) return;

              // Only scroll when editor has focus
              if (!view.hasFocus()) return;

              // Only scroll when selection changed
              const { from } = view.state.selection;
              const { from: prevFrom } = prevState.selection;
              if (from === prevFrom) return;

              // Get cursor coordinates
              const coords = view.coordsAtPos(from);
              if (!coords) return;

              // Get the editor's scroll container
              const editorDOM = view.dom;
              const scrollContainer =
                editorDOM.closest('.ProseMirror') ||
                editorDOM.parentElement ||
                editorDOM;

              if (!scrollContainer) return;

              // Calculate viewport center
              const rect = scrollContainer.getBoundingClientRect();
              const viewportCenter = rect.top + rect.height / 2;

              // Calculate how much to scroll
              const scrollOffset = coords.top - viewportCenter;

              // Only scroll if cursor is significantly off-center
              // This prevents jittery scrolling on small movements
              if (Math.abs(scrollOffset) > 50) {
                // Smooth scroll to center cursor
                window.scrollBy({
                  top: scrollOffset,
                  left: 0, // Never scroll horizontally
                  behavior: 'smooth',
                });
              }
            },
          };
        },
      }),
    ];
  },
});

export default TypewriterMode;
```
  </action>
  <verify>
    Run `npm run build` - TypeScript compiles without errors
  </verify>
  <done>
    TypewriterMode extension created with enable/disable/toggle commands and smooth cursor centering
  </done>
</task>

<task type="auto">
  <name>Task 3: Create StatusBar component</name>
  <files>
    src/components/StatusBar/StatusBar.tsx
    src/components/StatusBar/index.ts
  </files>
  <action>
1. Create directory: `src/components/StatusBar/`

2. Create `src/components/StatusBar/StatusBar.tsx`:

```typescript
/**
 * Status Bar Component
 * Bottom bar showing word count, character count, and cursor position
 */
import { useEffect, useState, useMemo } from 'react';
import type { Editor } from '@tiptap/core';

interface InterfaceColors {
  bg: string;
  bgSurface: string;
  border: string;
  textPrimary: string;
  textSecondary: string;
  textMuted: string;
}

interface StatusBarProps {
  editor: Editor | null;
  interfaceColors: InterfaceColors;
  /** Whether typewriter mode is enabled */
  typewriterEnabled?: boolean;
  /** Callback to toggle typewriter mode */
  onToggleTypewriter?: () => void;
}

interface DocumentStats {
  words: number;
  characters: number;
  line: number;
  column: number;
}

export function StatusBar({
  editor,
  interfaceColors,
  typewriterEnabled = false,
  onToggleTypewriter,
}: StatusBarProps) {
  const [stats, setStats] = useState<DocumentStats>({
    words: 0,
    characters: 0,
    line: 1,
    column: 1,
  });

  // Update stats on editor changes
  useEffect(() => {
    if (!editor) return;

    const updateStats = () => {
      // Get word/character count from CharacterCount extension
      const wordCount = editor.storage.characterCount?.words?.() ?? 0;
      const charCount = editor.storage.characterCount?.characters?.() ?? 0;

      // Calculate line and column from selection
      const { from } = editor.state.selection;
      const $pos = editor.state.doc.resolve(from);

      // Find which paragraph/block we're in for line number
      let line = 1;
      let charsBefore = 0;

      editor.state.doc.descendants((node, pos) => {
        if (pos >= from) return false; // Stop when we reach cursor
        if (node.isBlock) {
          line++;
          charsBefore = 0;
        } else if (node.isText) {
          charsBefore += node.text?.length ?? 0;
        }
        return true;
      });

      // Column is offset within current block
      const parentOffset = from - $pos.start($pos.depth);
      const column = parentOffset + 1;

      setStats({
        words: wordCount,
        characters: charCount,
        line: Math.max(1, line),
        column: Math.max(1, column),
      });
    };

    // Initial update
    updateStats();

    // Subscribe to changes
    editor.on('update', updateStats);
    editor.on('selectionUpdate', updateStats);

    return () => {
      editor.off('update', updateStats);
      editor.off('selectionUpdate', updateStats);
    };
  }, [editor]);

  // Format number with comma separators
  const formatNumber = (n: number): string => {
    return n.toLocaleString();
  };

  return (
    <div
      className="status-bar flex items-center justify-between px-4 py-1.5 text-xs select-none shrink-0"
      style={{
        backgroundColor: interfaceColors.bgSurface,
        borderTop: `1px solid ${interfaceColors.border}`,
        color: interfaceColors.textMuted,
      }}
    >
      {/* Left side: document stats */}
      <div className="flex items-center gap-4">
        <span title="Word count">
          {formatNumber(stats.words)} word{stats.words !== 1 ? 's' : ''}
        </span>
        <span
          className="opacity-50"
          style={{ color: interfaceColors.border }}
        >
          |
        </span>
        <span title="Character count">
          {formatNumber(stats.characters)} char{stats.characters !== 1 ? 's' : ''}
        </span>
      </div>

      {/* Center: optional typewriter toggle */}
      {onToggleTypewriter && (
        <button
          onClick={onToggleTypewriter}
          className="px-2 py-0.5 rounded text-xs transition-colors"
          style={{
            backgroundColor: typewriterEnabled
              ? interfaceColors.border
              : 'transparent',
            color: typewriterEnabled
              ? interfaceColors.textPrimary
              : interfaceColors.textMuted,
          }}
          title={
            typewriterEnabled
              ? 'Disable typewriter mode'
              : 'Enable typewriter mode (keeps cursor centered)'
          }
        >
          Typewriter {typewriterEnabled ? 'ON' : 'OFF'}
        </button>
      )}

      {/* Right side: cursor position */}
      <div className="flex items-center gap-2">
        <span title="Cursor position">
          Ln {stats.line}, Col {stats.column}
        </span>
      </div>
    </div>
  );
}

export default StatusBar;
```

3. Create `src/components/StatusBar/index.ts`:
```typescript
export { StatusBar } from './StatusBar';
export { default } from './StatusBar';
```
  </action>
  <verify>
    Run `npm run build` - TypeScript compiles without errors
  </verify>
  <done>
    StatusBar component created with word count, character count, line/column display, and typewriter toggle
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes (no TypeScript errors)
2. Focus mode hook exists: `ls src/hooks/useFocusMode.ts`
3. TypewriterMode extension exists: `ls src/extensions/TypewriterMode.ts`
4. StatusBar component exists: `ls src/components/StatusBar/`
5. Focus mode CSS exists: `ls src/styles/focus-mode.css`
6. Grep confirms focus mode shortcut: `grep -n "mod+shift+f" src/hooks/useFocusMode.ts`
</verification>

<success_criteria>
- useFocusMode hook toggles with Cmd+Shift+F and Escape
- Focus mode hides toolbar, panels, status bar via CSS class
- Focus mode shows exit hint on hover at top of screen
- TypewriterMode extension keeps cursor vertically centered
- StatusBar displays word count, character count, line, column
- StatusBar includes optional typewriter mode toggle button
- Word count matches editor.storage.characterCount.words() exactly
- Character count matches editor.storage.characterCount.characters() exactly
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish/05-03-SUMMARY.md`
</output>
