---
phase: 08-document-output-and-pagination
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/stores/editorStore.ts
  - src/components/Editor/MarkdownEditor.tsx
  - src/components/Editor/EditorCore.tsx
  - src/styles/markdown-editor.css
autonomous: true

must_haves:
  truths:
    - "User can toggle to Markdown source view with Cmd+/"
    - "Markdown source has syntax highlighting"
    - "Changes in Markdown view sync to rendered view on switch"
  artifacts:
    - path: "src/components/Editor/MarkdownEditor.tsx"
      provides: "CodeMirror-based Markdown editor component"
      exports: ["MarkdownEditor"]
    - path: "src/stores/editorStore.ts"
      provides: "viewMode state ('rendered' | 'source')"
      contains: "viewMode"
    - path: "src/styles/markdown-editor.css"
      provides: "Markdown editor styling"
      contains: ".markdown-editor"
  key_links:
    - from: "src/components/Editor/EditorCore.tsx"
      to: "src/stores/editorStore.ts"
      via: "useEditorStore viewMode"
      pattern: "viewMode"
    - from: "src/components/Editor/EditorCore.tsx"
      to: "src/components/Editor/MarkdownEditor.tsx"
      via: "conditional render based on viewMode"
      pattern: "MarkdownEditor"
---

<objective>
Implement Markdown source view mode with syntax highlighting and bidirectional sync.

Purpose: Power users want to see and edit raw Markdown for precise control. This fulfills requirements MD-01 (toggle source view), MD-03 (bidirectional sync), and MD-04 (syntax highlighting). Split view (MD-02) will be a future enhancement.

Output: MarkdownEditor component using CodeMirror, view mode state in store, Cmd+/ keyboard shortcut to toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-document-output-and-pagination/08-RESEARCH.md
@src/stores/editorStore.ts
@src/components/Editor/EditorCore.tsx
@src/lib/export-handlers.ts (has jsonToMarkdown function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CodeMirror packages and add view mode state</name>
  <files>package.json, src/stores/editorStore.ts</files>
  <action>
1. Install CodeMirror packages:
```bash
cd /Users/jacquesdubnov/Coding/serq && npm install @uiw/react-codemirror @codemirror/lang-markdown @codemirror/theme-one-dark
```

Note: @codemirror/theme-one-dark provides a nice dark theme; we'll also use the default light theme.

2. In src/stores/editorStore.ts, add view mode state:

Add type:
```typescript
type ViewMode = 'rendered' | 'source'
```

Add to EditorState interface:
```typescript
viewMode: ViewMode
setViewMode: (mode: ViewMode) => void
markdownSource: string
setMarkdownSource: (md: string) => void
```

Add initial state:
```typescript
viewMode: 'rendered',
markdownSource: '',
```

Add actions:
```typescript
setViewMode: (mode) => {
  set({ viewMode: mode })
},
setMarkdownSource: (md) => {
  set({ markdownSource: md })
},
```

Export ViewMode type.
  </action>
  <verify>
`npm ls @uiw/react-codemirror` shows installed
`grep -c "viewMode" src/stores/editorStore.ts` returns at least 3 matches
  </verify>
  <done>CodeMirror installed, view mode state added to store.</done>
</task>

<task type="auto">
  <name>Task 2: Create MarkdownEditor component</name>
  <files>src/components/Editor/MarkdownEditor.tsx, src/styles/markdown-editor.css</files>
  <action>
1. Create src/styles/markdown-editor.css:
```css
/**
 * Markdown Editor Styles
 * CodeMirror-based Markdown source view
 */

.markdown-editor {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.markdown-editor .cm-editor {
  height: 100%;
  font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', 'Menlo', monospace;
  font-size: 14px;
  line-height: 1.6;
}

.markdown-editor .cm-editor .cm-scroller {
  padding: 24px;
}

.markdown-editor .cm-editor.cm-focused {
  outline: none;
}

/* Light theme adjustments */
.markdown-editor .cm-editor .cm-content {
  caret-color: var(--color-text, #1a1a1a);
}

.markdown-editor .cm-editor .cm-line {
  padding: 0 4px;
}

/* Markdown-specific syntax highlighting enhancements */
.markdown-editor .cm-header {
  font-weight: bold;
}

.markdown-editor .cm-header-1 {
  font-size: 1.5em;
}

.markdown-editor .cm-header-2 {
  font-size: 1.3em;
}

.markdown-editor .cm-header-3 {
  font-size: 1.1em;
}

.markdown-editor .cm-quote {
  color: #6a737d;
  font-style: italic;
}

.markdown-editor .cm-link {
  color: #0969da;
  text-decoration: underline;
}

.markdown-editor .cm-url {
  color: #6a737d;
}

/* Dark mode */
[data-theme="dark"] .markdown-editor .cm-editor {
  background-color: var(--interface-bg, #1a1a1a);
}
```

2. Create src/components/Editor/MarkdownEditor.tsx:
```typescript
/**
 * Markdown Editor Component
 * CodeMirror-based Markdown source view with syntax highlighting
 */
import { useCallback, useEffect, useRef } from 'react'
import CodeMirror, { ReactCodeMirrorRef } from '@uiw/react-codemirror'
import { markdown } from '@codemirror/lang-markdown'
import { oneDark } from '@codemirror/theme-one-dark'
import { EditorView } from '@codemirror/view'
import '../../styles/markdown-editor.css'

interface MarkdownEditorProps {
  value: string
  onChange: (value: string) => void
  isDarkMode?: boolean
}

export function MarkdownEditor({ value, onChange, isDarkMode = false }: MarkdownEditorProps) {
  const editorRef = useRef<ReactCodeMirrorRef>(null)

  // Handle content changes
  const handleChange = useCallback((val: string) => {
    onChange(val)
  }, [onChange])

  // Focus editor when mounted
  useEffect(() => {
    if (editorRef.current?.view) {
      editorRef.current.view.focus()
    }
  }, [])

  // Base extensions
  const extensions = [
    markdown(),
    EditorView.lineWrapping,
    EditorView.theme({
      '&': { height: '100%' },
      '.cm-scroller': { overflow: 'auto' },
    }),
  ]

  return (
    <div className="markdown-editor">
      <CodeMirror
        ref={editorRef}
        value={value}
        height="100%"
        extensions={extensions}
        theme={isDarkMode ? oneDark : 'light'}
        onChange={handleChange}
        basicSetup={{
          lineNumbers: true,
          highlightActiveLineGutter: true,
          highlightActiveLine: true,
          foldGutter: true,
          dropCursor: true,
          allowMultipleSelections: true,
          indentOnInput: true,
          bracketMatching: true,
          closeBrackets: true,
          autocompletion: false, // Disable for markdown
          rectangularSelection: true,
          crosshairCursor: false,
          highlightSelectionMatches: true,
          searchKeymap: true,
        }}
      />
    </div>
  )
}

export default MarkdownEditor
```
  </action>
  <verify>
`ls src/components/Editor/MarkdownEditor.tsx` confirms file exists
`ls src/styles/markdown-editor.css` confirms file exists
`grep -c "CodeMirror" src/components/Editor/MarkdownEditor.tsx` returns at least 1
  </verify>
  <done>MarkdownEditor component created with syntax highlighting and proper styling.</done>
</task>

<task type="auto">
  <name>Task 3: Wire view mode toggle to EditorCore with Cmd+/ shortcut</name>
  <files>src/components/Editor/EditorCore.tsx, src/hooks/useKeyboardShortcuts.ts</files>
  <action>
1. In src/components/Editor/EditorCore.tsx:

Add imports:
```typescript
import { MarkdownEditor } from './MarkdownEditor'
import { useEditorStore } from '../../stores/editorStore'
```

Note: We need access to the existing jsonToMarkdown function from export-handlers.
Add import:
```typescript
// For JSON to Markdown conversion - reuse existing function
// We'll need to extract it or create a shared utility
```

Add state selectors:
```typescript
const viewMode = useEditorStore((state) => state.viewMode)
const setViewMode = useEditorStore((state) => state.setViewMode)
const markdownSource = useEditorStore((state) => state.markdownSource)
const setMarkdownSource = useEditorStore((state) => state.setMarkdownSource)
```

Add conversion functions (or move jsonToMarkdown to a shared location):
Since jsonToMarkdown already exists in export-handlers.ts, we can either:
a) Export it from there and import here, or
b) Duplicate the logic for now

Option (a) is cleaner. In export-handlers.ts, make sure `jsonToMarkdown` is exported:
```typescript
export function jsonToMarkdown(doc: TipTapNode): string { ... }
```

Then import in EditorCore:
```typescript
import { jsonToMarkdown } from '../../lib/export-handlers'
```

Add sync logic when switching modes:
```typescript
// When switching to source mode, convert current content to markdown
const handleSwitchToSource = useCallback(() => {
  if (editor) {
    const json = editor.getJSON()
    const md = jsonToMarkdown(json)
    setMarkdownSource(md)
    setViewMode('source')
  }
}, [editor, setMarkdownSource, setViewMode])

// When switching back to rendered, parse markdown and update editor
const handleSwitchToRendered = useCallback(() => {
  if (editor && markdownSource) {
    // Use editor's setContent with markdown content
    // TipTap can parse basic markdown via the StarterKit
    // For full markdown support, we'd need @tiptap/extension-markdown
    // For now, do a basic conversion back
    editor.commands.setContent(markdownToHtml(markdownSource))
  }
  setViewMode('rendered')
}, [editor, markdownSource, setViewMode])

// Simple markdown to HTML for basic elements
function markdownToHtml(md: string): string {
  let html = md
    // Headings
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    // Bold and italic
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    // Code
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
    // Paragraphs (lines that don't match other patterns)
    .split('\n\n')
    .map(p => p.trim())
    .filter(p => p && !p.startsWith('<'))
    .map(p => `<p>${p}</p>`)
    .join('\n')

  return html
}
```

Add conditional rendering in the component return:
```tsx
return (
  <div className="editor-container">
    {viewMode === 'rendered' ? (
      <EditorContent editor={editor} className="prose-editor" />
    ) : (
      <MarkdownEditor
        value={markdownSource}
        onChange={setMarkdownSource}
        isDarkMode={document.documentElement.dataset.theme === 'dark'}
      />
    )}
  </div>
)
```

2. Add Cmd+/ keyboard shortcut in src/hooks/useKeyboardShortcuts.ts:

Add to imports/dependencies:
```typescript
const viewMode = useEditorStore((state) => state.viewMode)
const setViewMode = useEditorStore((state) => state.setViewMode)
const setMarkdownSource = useEditorStore((state) => state.setMarkdownSource)
```

Add shortcut registration:
```typescript
// Toggle Markdown source view: Cmd+/
useHotkeys('meta+/', (e) => {
  e.preventDefault()
  if (viewMode === 'rendered') {
    // Switch to source
    const editor = editorRef.current
    if (editor) {
      const json = editor.getJSON()
      const md = jsonToMarkdown(json)
      setMarkdownSource(md)
      setViewMode('source')
    }
  } else {
    // Switch back to rendered
    setViewMode('rendered')
    // Note: Full sync from markdown to editor would happen in EditorCore
  }
}, {
  enableOnContentEditable: true,
  enabled: true,
}, [viewMode, editorRef])
```

Also add Ctrl+/ for non-Mac:
```typescript
useHotkeys('ctrl+/', (e) => { ... }, { ... })
```
  </action>
  <verify>
1. `npm run build` completes without errors
2. `grep -c "viewMode" src/components/Editor/EditorCore.tsx` returns at least 2
3. `grep -c "MarkdownEditor" src/components/Editor/EditorCore.tsx` returns at least 2
4. `grep -c "meta+/" src/hooks/useKeyboardShortcuts.ts` returns 1
  </verify>
  <done>View mode toggle wired with Cmd+/ shortcut, markdown source syncs with editor content.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm ls @uiw/react-codemirror` shows installed
3. `ls src/components/Editor/MarkdownEditor.tsx` confirms file exists
4. `grep "viewMode" src/stores/editorStore.ts` shows state
5. Manual test:
   - Create document with heading, paragraph, bold text, list
   - Press Cmd+/ - should switch to Markdown source view with syntax highlighting
   - Press Cmd+/ again - should switch back to rendered view
   - Make edits in source view, switch back - content should reflect changes
</verification>

<success_criteria>
- CodeMirror packages installed (@uiw/react-codemirror, @codemirror/lang-markdown)
- MarkdownEditor component with Markdown syntax highlighting
- viewMode state in editorStore ('rendered' | 'source')
- Cmd+/ keyboard shortcut toggles between modes
- Content syncs between modes (rendered to source uses jsonToMarkdown)
</success_criteria>

<output>
After completion, create `.planning/phases/08-document-output-and-pagination/08-04-SUMMARY.md`
</output>
