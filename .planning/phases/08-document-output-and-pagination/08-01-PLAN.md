---
phase: 08-document-output-and-pagination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/export-handlers.ts
autonomous: true

must_haves:
  truths:
    - "User can export to PDF with file size under 5MB for text-only documents"
    - "PDF visual quality remains acceptable (no visible artifacts)"
  artifacts:
    - path: "src/lib/export-handlers.ts"
      provides: "JPEG-compressed PDF export"
      contains: "image/jpeg"
  key_links:
    - from: "src/lib/export-handlers.ts"
      to: "jsPDF"
      via: "addImage with JPEG format and FAST compression"
      pattern: "JPEG.*FAST"
---

<objective>
Optimize PDF export to reduce 80MB file sizes to under 5MB by switching from PNG to JPEG with compression.

Purpose: The current PDF export creates unacceptably large files (80MB+ for simple text) because it captures the entire document as PNG images at 2x scale. PNG is lossless, hence massive files. JPEG with 75% quality and FAST compression reduces file size 10-30x with minimal visible quality loss.

Output: Modified exportToPDF function in export-handlers.ts using JPEG compression.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-document-output-and-pagination/08-RESEARCH.md
@src/lib/export-handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace PNG with JPEG compression in PDF export</name>
  <files>src/lib/export-handlers.ts</files>
  <action>
In the exportToPDF function, change the image generation and PDF insertion to use JPEG:

1. Replace `canvas.toDataURL('image/png')` with `canvas.toDataURL('image/jpeg', 0.75)`
   - The 0.75 is 75% quality - good balance between size and visual quality
   - Apply this change to both the multi-page slices loop and any single-page paths

2. In all pdf.addImage() calls, change:
   - Format from 'PNG' to 'JPEG'
   - Add 'FAST' compression flag as the last parameter

Before (around line 540):
```typescript
const sliceImgData = pageCanvas.toDataURL('image/png')
pdf.addImage(sliceImgData, 'PNG', margin, margin, contentWidth, sliceHeightMm)
```

After:
```typescript
const sliceImgData = pageCanvas.toDataURL('image/jpeg', 0.75)
pdf.addImage(sliceImgData, 'JPEG', margin, margin, contentWidth, sliceHeightMm, undefined, 'FAST')
```

Note: The undefined is for the 'alias' parameter which we don't need.

3. Add a size check after PDF generation with console log:
```typescript
const pdfOutput = pdf.output('arraybuffer')
const sizeInMB = (pdfOutput.byteLength / (1024 * 1024)).toFixed(2)
console.log(`[PDF Export] PDF generated, size: ${sizeInMB}MB`)
```
  </action>
  <verify>
Build the project with `npm run build` - should have no TypeScript errors.
Open the app, create a text document, export to PDF. Verify:
1. File size is under 5MB for a single-page text document
2. Visual quality is acceptable (text is readable, no major artifacts)
  </verify>
  <done>PDF export produces files 10-30x smaller than before while maintaining readable quality.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `grep -n "image/jpeg" src/lib/export-handlers.ts` returns matches
3. `grep -n "FAST" src/lib/export-handlers.ts` returns matches
4. Manual test: Create a 2-3 page document, export to PDF, verify file size < 10MB
</verification>

<success_criteria>
- PDF export uses JPEG format with 0.75 quality
- PDF addImage uses 'FAST' compression flag
- Exported PDFs are 10-30x smaller than before
- Visual quality remains acceptable for text documents
</success_criteria>

<output>
After completion, create `.planning/phases/08-document-output-and-pagination/08-01-SUMMARY.md`
</output>
