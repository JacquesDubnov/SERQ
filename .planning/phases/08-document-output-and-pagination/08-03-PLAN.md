---
phase: 08-document-output-and-pagination
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/editorStore.ts
  - src/styles/pagination.css
  - src/components/Editor/Canvas.tsx
  - src/components/Toolbar/Toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle pagination mode on/off"
    - "User can select page size (A4, Letter, Legal)"
    - "Document displays with visual page breaks in pagination mode"
    - "Print output respects page size and avoids breaking headings/tables"
  artifacts:
    - path: "src/stores/editorStore.ts"
      provides: "Pagination state (enabled, pageSize)"
      contains: "paginationMode"
    - path: "src/styles/pagination.css"
      provides: "CSS @page rules and pagination styling"
      contains: "@page"
    - path: "src/components/Editor/Canvas.tsx"
      provides: "Canvas with pagination mode attribute"
      contains: "data-pagination"
  key_links:
    - from: "src/components/Editor/Canvas.tsx"
      to: "src/stores/editorStore.ts"
      via: "useEditorStore paginationMode"
      pattern: "paginationMode"
    - from: "src/styles/pagination.css"
      to: "CSS @media print"
      via: "@page rules"
      pattern: "@page"
---

<objective>
Implement pagination mode with page size selection for print-ready documents.

Purpose: Writers creating print documents need to see page boundaries while editing, and exported PDFs/prints should respect page sizes with proper break handling. This fulfills requirement FOUND-05 (pagination mode toggle).

Output: Pagination state in store, CSS paged media rules, page size selector, visual page boundaries in editor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-document-output-and-pagination/08-RESEARCH.md
@src/stores/editorStore.ts
@src/components/Editor/EditorCore.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination state to editorStore</name>
  <files>src/stores/editorStore.ts</files>
  <action>
Add pagination-related state to the editorStore:

1. Add type definition for page sizes:
```typescript
type PageSize = 'a4' | 'letter' | 'legal'

interface PaginationSettings {
  enabled: boolean
  pageSize: PageSize
}
```

2. Add to EditorState interface:
```typescript
pagination: PaginationSettings
setPaginationEnabled: (enabled: boolean) => void
setPageSize: (size: PageSize) => void
```

3. Add initial state in create():
```typescript
pagination: {
  enabled: false,
  pageSize: 'a4',
},
```

4. Add actions:
```typescript
setPaginationEnabled: (enabled) => {
  set((state) => ({
    pagination: { ...state.pagination, enabled },
  }))
},
setPageSize: (size) => {
  set((state) => ({
    pagination: { ...state.pagination, pageSize: size },
  }))
},
```

5. Export the PageSize type if needed elsewhere.
  </action>
  <verify>
`grep -c "paginationMode\|pagination:" src/stores/editorStore.ts` returns matches
TypeScript compiles without errors
  </verify>
  <done>Pagination state added to editorStore with enabled flag and page size selection.</done>
</task>

<task type="auto">
  <name>Task 2: Create pagination CSS with @page rules</name>
  <files>src/styles/pagination.css</files>
  <action>
Create src/styles/pagination.css with:

```css
/**
 * Pagination Mode Styles
 * CSS paged media rules for print-ready documents
 */

/* Page size dimensions (in mm for @page, in cm for visual) */
:root {
  /* A4: 210mm x 297mm */
  --page-width-a4: 21cm;
  --page-height-a4: 29.7cm;

  /* Letter: 216mm x 279mm */
  --page-width-letter: 21.6cm;
  --page-height-letter: 27.9cm;

  /* Legal: 216mm x 356mm */
  --page-width-legal: 21.6cm;
  --page-height-legal: 35.6cm;

  /* Default page margins */
  --page-margin: 2.5cm;
}

/* Visual page boundaries in editor when pagination is enabled */
.canvas[data-pagination="true"] {
  background: repeating-linear-gradient(
    to bottom,
    white 0,
    white calc(var(--page-height-a4) - 2mm),
    #e5e7eb calc(var(--page-height-a4) - 2mm),
    #e5e7eb var(--page-height-a4)
  );
}

.canvas[data-pagination="true"][data-page-size="a4"] {
  max-width: var(--page-width-a4);
  background-size: 100% var(--page-height-a4);
}

.canvas[data-pagination="true"][data-page-size="letter"] {
  max-width: var(--page-width-letter);
  background-size: 100% var(--page-height-letter);
  background: repeating-linear-gradient(
    to bottom,
    white 0,
    white calc(var(--page-height-letter) - 2mm),
    #e5e7eb calc(var(--page-height-letter) - 2mm),
    #e5e7eb var(--page-height-letter)
  );
}

.canvas[data-pagination="true"][data-page-size="legal"] {
  max-width: var(--page-width-legal);
  background-size: 100% var(--page-height-legal);
  background: repeating-linear-gradient(
    to bottom,
    white 0,
    white calc(var(--page-height-legal) - 2mm),
    #e5e7eb calc(var(--page-height-legal) - 2mm),
    #e5e7eb var(--page-height-legal)
  );
}

/* Page indicator markers (optional visual enhancement) */
.canvas[data-pagination="true"] .ProseMirror {
  padding: var(--page-margin);
}

/* Print-specific styles */
@media print {
  /* Reset canvas styles for print */
  .canvas {
    max-width: none !important;
    width: auto !important;
    margin: 0 !important;
    padding: 0 !important;
    box-shadow: none !important;
    background: white !important;
  }

  /* Hide non-print elements */
  .toolbar,
  .sidebar,
  .status-bar,
  .style-panel,
  .outline-panel {
    display: none !important;
  }

  /* Prevent orphans and widows */
  p {
    orphans: 3;
    widows: 3;
  }

  /* Avoid breaking after headings */
  h1, h2, h3, h4, h5, h6 {
    break-after: avoid;
    page-break-after: avoid;
  }

  /* Keep these elements together */
  table,
  figure,
  blockquote,
  .callout,
  pre,
  ul,
  ol {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* Table row handling */
  tr {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* Images */
  img {
    break-inside: avoid;
    page-break-inside: avoid;
    max-width: 100%;
  }
}

/* A4 print size */
@page a4 {
  size: A4;
  margin: 2.5cm;
}

/* Letter print size */
@page letter {
  size: letter;
  margin: 1in;
}

/* Legal print size */
@page legal {
  size: legal;
  margin: 1in;
}

/* Apply page size based on body attribute */
body[data-page-size="a4"] {
  @page { size: A4; margin: 2.5cm; }
}

body[data-page-size="letter"] {
  @page { size: letter; margin: 1in; }
}

body[data-page-size="legal"] {
  @page { size: legal; margin: 1in; }
}

/* First page can have different margins */
@page :first {
  margin-top: 3cm;
}

/* Manual page break class */
.page-break {
  break-before: page;
  page-break-before: always;
  height: 0;
  margin: 0;
  padding: 0;
}
```

Then import this CSS in main.tsx or App.tsx:
```typescript
import './styles/pagination.css'
```
  </action>
  <verify>
`ls src/styles/pagination.css` confirms file exists
`grep -c "@page" src/styles/pagination.css` returns at least 4 matches
  </verify>
  <done>Pagination CSS created with @page rules for all page sizes and visual page boundaries.</done>
</task>

<task type="auto">
  <name>Task 3: Wire pagination to Canvas and add toggle to Toolbar</name>
  <files>src/components/Editor/Canvas.tsx, src/components/Toolbar/Toolbar.tsx, src/main.tsx</files>
  <action>
1. In src/components/Editor/Canvas.tsx (or wherever the canvas container is):

Add to imports:
```typescript
import { useEditorStore } from '../../stores/editorStore'
```

Add state selection:
```typescript
const pagination = useEditorStore((state) => state.pagination)
```

Add data attributes to the canvas container div:
```typescript
<div
  className="canvas"
  data-pagination={pagination.enabled}
  data-page-size={pagination.pageSize}
  // ... other props
>
```

Also set the body attribute for print CSS:
```typescript
useEffect(() => {
  if (pagination.enabled) {
    document.body.setAttribute('data-page-size', pagination.pageSize)
  } else {
    document.body.removeAttribute('data-page-size')
  }
}, [pagination.enabled, pagination.pageSize])
```

2. In src/components/Toolbar/Toolbar.tsx:

Add state and actions:
```typescript
const pagination = useEditorStore((state) => state.pagination)
const setPaginationEnabled = useEditorStore((state) => state.setPaginationEnabled)
const setPageSize = useEditorStore((state) => state.setPageSize)
```

Add pagination toggle button and page size selector to the toolbar.
Find a suitable location (perhaps near the export button or in a "View" section).

Add something like:
```tsx
{/* Pagination controls */}
<div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
  <button
    onClick={() => setPaginationEnabled(!pagination.enabled)}
    title={pagination.enabled ? 'Disable pagination' : 'Enable pagination'}
    style={{
      padding: '4px 8px',
      borderRadius: '4px',
      border: `1px solid ${interfaceColors.border}`,
      backgroundColor: pagination.enabled ? interfaceColors.bgSurface : 'transparent',
      color: interfaceColors.textPrimary,
      cursor: 'pointer',
      fontSize: '12px',
    }}
  >
    {pagination.enabled ? 'Pages: On' : 'Pages: Off'}
  </button>

  {pagination.enabled && (
    <select
      value={pagination.pageSize}
      onChange={(e) => setPageSize(e.target.value as 'a4' | 'letter' | 'legal')}
      style={{
        padding: '4px 8px',
        borderRadius: '4px',
        border: `1px solid ${interfaceColors.border}`,
        backgroundColor: interfaceColors.bg,
        color: interfaceColors.textPrimary,
        fontSize: '12px',
        cursor: 'pointer',
      }}
    >
      <option value="a4">A4</option>
      <option value="letter">Letter</option>
      <option value="legal">Legal</option>
    </select>
  )}
</div>
```

3. Import pagination CSS in src/main.tsx (or src/App.tsx):
```typescript
import './styles/pagination.css'
```
  </action>
  <verify>
1. `npm run build` completes without errors
2. `grep -c "data-pagination" src/components/Editor/Canvas.tsx` returns at least 1
3. `grep -c "setPaginationEnabled" src/components/Toolbar/Toolbar.tsx` returns at least 1
4. `grep -c "pagination.css" src/main.tsx` returns 1
  </verify>
  <done>Pagination mode fully wired: store state, CSS, canvas data attributes, and toolbar controls.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `ls src/styles/pagination.css` confirms CSS file exists
3. `grep "pagination" src/stores/editorStore.ts` shows state and actions
4. `grep "data-pagination" src/components/Editor/Canvas.tsx` shows attribute binding
5. Manual test:
   - Toggle pagination on - canvas should show page boundaries as gray lines
   - Change page size - canvas width and page boundary spacing should adjust
   - Print preview (Cmd+P) - pages should break cleanly, not cutting through headings/tables
</verification>

<success_criteria>
- Pagination state in editorStore (enabled + pageSize)
- CSS @page rules for A4, Letter, Legal
- Visual page boundaries in editor when pagination enabled
- Page size selector in toolbar
- Print output respects page size and avoids breaking headings/tables
</success_criteria>

<output>
After completion, create `.planning/phases/08-document-output-and-pagination/08-03-SUMMARY.md`
</output>
