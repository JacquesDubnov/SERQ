---
phase: 06-ai-integration
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - src/hooks/useAiStylization.ts
  - src/components/Editor/EditorCore.tsx
  - src/App.tsx
  - src/components/CommandPalette/commands.ts
  - src/extensions/SlashCommands/commands.ts
autonomous: false

must_haves:
  truths:
    - "User can select text and invoke AI stylization via command palette"
    - "User can select text and invoke AI stylization via slash command"
    - "User can select text and invoke AI stylization via keyboard shortcut"
    - "Accepting AI suggestion replaces selected text with AI result"
    - "Rejecting AI suggestion leaves original text unchanged"
    - "Undo after accept restores original text"
  artifacts:
    - path: "src/hooks/useAiStylization.ts"
      provides: "Hook connecting editor selection to AI store"
      exports: ["useAiStylization"]
    - path: "src/components/Editor/EditorCore.tsx"
      provides: "Editor with AI preview integration"
    - path: "src/App.tsx"
      provides: "App with AI preview panel"
  key_links:
    - from: "src/hooks/useAiStylization.ts"
      to: "src/stores/aiStore.ts"
      via: "useAiStore for state"
      pattern: "useAiStore"
    - from: "src/hooks/useAiStylization.ts"
      to: "editor.chain"
      via: "TipTap commands for accept"
      pattern: "editor\\.chain.*deleteRange.*insertContent"
    - from: "src/components/Editor/EditorCore.tsx"
      to: "src/components/AiPreview/AiPreviewPanel.tsx"
      via: "renders AiPreviewPanel"
      pattern: "<AiPreviewPanel"
---

<objective>
Wire AI preview panel to editor - selection capture, accept/reject actions, and multiple invoke methods.

Purpose: This plan connects all the pieces together. The user needs to select text, trigger AI, see the result, and accept/reject. The editor must properly handle the text replacement with undo support.

Output: Complete working AI stylization feature accessible via command palette, slash commands, and keyboard shortcut.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-ai-integration/06-RESEARCH.md
@.planning/phases/06-ai-integration/06-03-SUMMARY.md

# Editor and commands
@src/components/Editor/EditorCore.tsx
@src/components/CommandPalette/commands.ts
@src/extensions/SlashCommands/commands.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAiStylization hook for editor integration</name>
  <files>
    src/hooks/useAiStylization.ts
    src/hooks/index.ts
  </files>
  <action>
1. Create src/hooks/useAiStylization.ts:

```typescript
import { useCallback } from 'react';
import type { Editor } from '@tiptap/core';
import { useAiStore } from '../stores/aiStore';

interface UseAiStylizationOptions {
  editor: Editor | null;
}

interface AiStylizationActions {
  /** Start AI stylization on current selection */
  startStylization: () => void;
  /** Accept AI result and replace selected text */
  acceptResult: () => void;
  /** Reject AI result and keep original */
  rejectResult: () => void;
  /** Check if text is selected (AI requires selection) */
  hasSelection: boolean;
  /** Check if AI stylization is available (has API key) */
  isAvailable: boolean;
}

/**
 * Hook to integrate AI stylization with TipTap editor
 *
 * Usage:
 * ```tsx
 * const { startStylization, acceptResult, rejectResult, hasSelection } = useAiStylization({ editor });
 *
 * // Trigger from command palette
 * if (hasSelection) startStylization();
 * ```
 */
export function useAiStylization({ editor }: UseAiStylizationOptions): AiStylizationActions {
  const { originalRange, resultText, showPreview } = useAiStore();
  const storeStartStylization = useAiStore((s) => s.startStylization);
  const storeAcceptResult = useAiStore((s) => s.acceptResult);
  const storeRejectResult = useAiStore((s) => s.rejectResult);

  /**
   * Get current selection text and range from editor
   */
  const getSelection = useCallback(() => {
    if (!editor) return null;

    const { from, to } = editor.state.selection;
    if (from === to) return null; // No selection

    const text = editor.state.doc.textBetween(from, to, ' ');
    if (!text.trim()) return null;

    return { text, from, to };
  }, [editor]);

  /**
   * Get surrounding document context for AI (helps match tone)
   * Gets ~500 chars before and after selection
   */
  const getDocumentContext = useCallback(() => {
    if (!editor) return undefined;

    const { from, to } = editor.state.selection;
    const docSize = editor.state.doc.content.size;

    const contextStart = Math.max(0, from - 500);
    const contextEnd = Math.min(docSize, to + 500);

    const before = editor.state.doc.textBetween(contextStart, from, ' ');
    const after = editor.state.doc.textBetween(to, contextEnd, ' ');

    if (!before && !after) return undefined;

    return `[Before selection]: ${before}\n[After selection]: ${after}`;
  }, [editor]);

  /**
   * Start stylization flow - captures selection and opens style selector
   */
  const startStylization = useCallback(() => {
    const selection = getSelection();
    if (!selection) return;

    const context = getDocumentContext();

    // Set the selection info in store but don't start API call yet
    // Store will be in "showPreview" mode, user selects style, then API is called
    useAiStore.setState({
      originalText: selection.text,
      originalRange: { from: selection.from, to: selection.to },
      showPreview: true,
      streamingText: '',
      resultText: null,
      error: null,
      isLoading: false,
    });
  }, [getSelection, getDocumentContext]);

  /**
   * Accept result - replace selected text with AI result
   * Uses single transaction for proper undo support
   */
  const acceptResult = useCallback(() => {
    if (!editor || !originalRange || !resultText) {
      storeAcceptResult();
      return;
    }

    // Single transaction: select range, delete, insert new content
    editor
      .chain()
      .focus()
      .setTextSelection(originalRange)
      .deleteSelection()
      .insertContent(resultText)
      .run();

    storeAcceptResult();
  }, [editor, originalRange, resultText, storeAcceptResult]);

  /**
   * Reject result - close preview, keep original text
   */
  const rejectResult = useCallback(() => {
    // Just reset store state, editor content unchanged
    storeRejectResult();
  }, [storeRejectResult]);

  const hasSelection = Boolean(editor && !editor.state.selection.empty);

  // TODO: Check if API key is configured
  // For now, assume available - error will show if not configured
  const isAvailable = true;

  return {
    startStylization,
    acceptResult,
    rejectResult,
    hasSelection,
    isAvailable,
  };
}
```

2. Update src/hooks/index.ts to export the new hook:
   Add: `export { useAiStylization } from './useAiStylization';`
  </action>
  <verify>
- File exists at src/hooks/useAiStylization.ts
- Exported from src/hooks/index.ts
- TypeScript compiles: `npm run build` passes
  </verify>
  <done>
useAiStylization hook connects editor selection to AI store with accept/reject actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AI commands to command palette and slash menu</name>
  <files>
    src/components/CommandPalette/commands.ts
    src/extensions/SlashCommands/commands.ts
  </files>
  <action>
1. Update src/components/CommandPalette/commands.ts:

Add AI commands to the commands array. Read the file first to understand the structure, then add:

```typescript
// In the commands array, add an AI section:
{
  id: 'ai-stylize',
  title: 'AI: Stylize Selection',
  shortcut: '⌘⇧I',
  group: 'ai',
  keywords: ['ai', 'stylize', 'rewrite', 'claude', 'style'],
  action: (editor) => {
    // This triggers via keyboard shortcut or palette selection
    // The actual handler will be in EditorCore using useAiStylization
    // We dispatch a custom event that EditorCore listens to
    window.dispatchEvent(new CustomEvent('serq:ai-stylize'));
  },
},
```

Also add 'ai' to the CommandGroup type if it doesn't exist.

Update the group definitions to include AI:
```typescript
// Add to group labels/ordering
'ai': 'AI',
```

2. Update src/extensions/SlashCommands/commands.ts:

Add AI slash command. Read file first, then add:

```typescript
// In the slash commands array, add:
{
  id: 'ai-stylize',
  title: 'AI Stylize',
  description: 'Rewrite selected text with AI',
  icon: '✨', // or appropriate icon
  keywords: ['ai', 'stylize', 'rewrite', 'claude'],
  action: (editor) => {
    // Dispatch event for EditorCore to handle
    window.dispatchEvent(new CustomEvent('serq:ai-stylize'));
  },
},
```

Note: The actual AI flow is triggered via custom event because:
1. Command palette and slash commands don't have access to React hooks
2. EditorCore has the useAiStylization hook and handles the event
3. This pattern keeps command definitions simple and UI logic in React
  </action>
  <verify>
- Command palette includes 'AI: Stylize Selection' command
- Slash menu includes 'AI Stylize' option
- TypeScript compiles without errors
  </verify>
  <done>
AI commands added to command palette (Cmd+K > search "AI") and slash menu (/ > search "ai")
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate AI preview panel into editor and app</name>
  <files>
    src/components/Editor/EditorCore.tsx
    src/App.tsx
  </files>
  <action>
1. Update src/components/Editor/EditorCore.tsx:

Add imports:
```typescript
import { useAiStylization } from '../../hooks/useAiStylization';
import { AiPreviewPanel } from '../AiPreview';
import { useAiStore } from '../../stores/aiStore';
```

Inside the component:
```typescript
// Add hook
const { startStylization, acceptResult, rejectResult, hasSelection } = useAiStylization({ editor });
const showAiPreview = useAiStore((s) => s.showPreview);
const aiOriginalText = useAiStore((s) => s.originalText);

// Add effect to listen for AI stylize event
useEffect(() => {
  const handleAiStylize = () => {
    if (hasSelection) {
      startStylization();
    }
  };

  window.addEventListener('serq:ai-stylize', handleAiStylize);
  return () => window.removeEventListener('serq:ai-stylize', handleAiStylize);
}, [hasSelection, startStylization]);

// Add keyboard shortcut for Cmd+Shift+I
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'i') {
      e.preventDefault();
      if (hasSelection) {
        startStylization();
      }
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [hasSelection, startStylization]);

// Get document context for AI
const getDocumentContext = useCallback(() => {
  if (!editor) return undefined;
  // Get first 1000 chars of document as context
  const docSize = editor.state.doc.content.size;
  const contextEnd = Math.min(docSize, 1000);
  return editor.state.doc.textBetween(0, contextEnd, ' ');
}, [editor]);
```

In the JSX return, add the AI preview panel:
```tsx
{/* AI Preview Panel */}
{showAiPreview && (
  <AiPreviewPanel
    onAccept={(newText, range) => acceptResult()}
    onReject={() => rejectResult()}
    documentContext={getDocumentContext()}
  />
)}
```

2. Ensure src/App.tsx has the necessary styling imports:

Add to the imports if not present:
```typescript
import './styles/ai-preview.css';
```

This ensures the AI preview CSS is loaded.

Note: The AiPreviewPanel is positioned fixed, so it can be rendered anywhere in the component tree. Placing it in EditorCore makes sense since it's editor-related functionality.
  </action>
  <verify>
- EditorCore renders AiPreviewPanel when showAiPreview is true
- Cmd+Shift+I triggers AI stylization when text is selected
- Custom event 'serq:ai-stylize' triggers startStylization
- TypeScript compiles without errors
  </verify>
  <done>
AI preview panel integrated into editor with keyboard shortcut, custom event handling, and document context
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AI text stylization feature with:
- Secure API key storage in macOS Keychain
- Claude API streaming via Tauri Channel
- Word-level diff preview showing changes
- Accept/reject workflow with full undo support
- Multiple invoke methods (Cmd+Shift+I, command palette, slash command)
  </what-built>
  <how-to-verify>
1. **Configure API Key:**
   - Find ApiKeySettings component in the app (may need to add temporarily to test)
   - Enter your Claude API key from console.anthropic.com
   - Verify key shows as "configured" after save
   - Check macOS Keychain Access app for "anthropic-api-key" under "com.serq.app"

2. **Test AI Stylization Flow:**
   - Type some text in the editor: "The meeting went okay I guess"
   - Select the text
   - Press Cmd+Shift+I (or use command palette: Cmd+K > "AI")
   - AI preview panel should appear on bottom-right
   - Select "More Formal" preset and click "Apply Style"
   - Watch streaming text appear in real-time
   - Diff view should show removed words (strikethrough, red) and added words (green)
   - Click "Accept" - text should be replaced
   - Press Cmd+Z - original text should be restored (undo works)

3. **Test Slash Command:**
   - Select different text
   - Type "/" and search for "ai" or "stylize"
   - Should see AI Stylize option
   - Selecting it should open the AI preview panel

4. **Test Error Handling:**
   - Remove API key (or use invalid key)
   - Try to stylize text
   - Should show error message about API key not configured

5. **Test Custom Instructions:**
   - Select text
   - Trigger AI stylization
   - Switch to "Custom" tab
   - Enter: "Make it sound like a pirate"
   - Click "Apply Style"
   - Verify streaming works with custom instructions

6. **Visual Verification:**
   - Panel styling looks correct in both light and dark modes
   - Loading spinner appears during streaming
   - Blinking cursor shows during streaming
   - Accept button is green, Reject is gray
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
Human verification required for this plan. See checkpoint task above.
</verification>

<success_criteria>
- User can select text and trigger AI via Cmd+Shift+I
- User can select text and trigger AI via command palette
- User can select text and trigger AI via slash command
- Streaming text appears character by character in real-time
- Diff view shows additions in green, removals in strikethrough red
- Accept replaces text, Reject keeps original
- Undo after Accept restores original text
- Errors are displayed in panel (API key missing, API errors)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-integration/06-04-SUMMARY.md`
</output>
