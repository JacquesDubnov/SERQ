---
phase: 06-ai-integration
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/components/AiPreview/AiPreviewPanel.tsx
  - src/components/AiPreview/DiffView.tsx
  - src/components/AiPreview/StyleSelector.tsx
  - src/components/AiPreview/index.ts
  - src/styles/ai-preview.css
autonomous: true

must_haves:
  truths:
    - "User sees streaming text appear character by character"
    - "User sees diff view comparing original vs AI result"
    - "User can select style preset or enter custom instructions"
    - "Accept button is visible and clickable"
    - "Reject button is visible and clickable"
    - "Panel shows loading state during streaming"
  artifacts:
    - path: "src/components/AiPreview/AiPreviewPanel.tsx"
      provides: "Main AI preview panel component"
      exports: ["AiPreviewPanel"]
    - path: "src/components/AiPreview/DiffView.tsx"
      provides: "Word-level diff visualization"
      exports: ["DiffView"]
    - path: "src/components/AiPreview/StyleSelector.tsx"
      provides: "Style preset dropdown and custom input"
      exports: ["StyleSelector"]
    - path: "src/styles/ai-preview.css"
      provides: "Styling for AI preview components"
  key_links:
    - from: "src/components/AiPreview/AiPreviewPanel.tsx"
      to: "src/stores/aiStore.ts"
      via: "useAiStore hook"
      pattern: "useAiStore"
    - from: "src/components/AiPreview/AiPreviewPanel.tsx"
      to: "src/components/AiPreview/DiffView.tsx"
      via: "renders DiffView with original/result"
      pattern: "<DiffView"
---

<objective>
Build the AI preview UI components - streaming display, diff view, and accept/reject workflow.

Purpose: Users need to see what AI is generating in real-time and compare it to their original text before accepting. This plan creates the visual interface for the entire AI workflow.

Output: Complete preview panel with streaming display, word-level diff, style selection, and accept/reject buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-ai-integration/06-RESEARCH.md
@.planning/phases/06-ai-integration/06-02-SUMMARY.md

# Stores
@src/stores/aiStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffView component for comparing original vs result</name>
  <files>
    src/components/AiPreview/DiffView.tsx
  </files>
  <action>
Create src/components/AiPreview/ directory and DiffView.tsx:

```tsx
import { useMemo } from 'react';

interface DiffViewProps {
  original: string;
  modified: string;
  isStreaming?: boolean;
}

type DiffItem = {
  type: 'same' | 'add' | 'remove';
  text: string;
};

/**
 * Simple word-level diff algorithm
 * Uses longest common subsequence approach for accurate diffs
 */
function computeWordDiff(original: string, modified: string): DiffItem[] {
  const origWords = original.split(/(\s+)/); // Keep whitespace
  const modWords = modified.split(/(\s+)/);

  // Simple diff: match words, mark additions/deletions
  const result: DiffItem[] = [];
  let i = 0;
  let j = 0;

  while (i < origWords.length || j < modWords.length) {
    if (i >= origWords.length) {
      // Rest are additions
      result.push({ type: 'add', text: modWords[j++] });
    } else if (j >= modWords.length) {
      // Rest are deletions
      result.push({ type: 'remove', text: origWords[i++] });
    } else if (origWords[i] === modWords[j]) {
      // Match
      result.push({ type: 'same', text: origWords[i] });
      i++;
      j++;
    } else {
      // Mismatch - look ahead to find best match
      // Simple approach: if next orig matches current mod, it's an insertion
      // If next mod matches current orig, it's a deletion
      // Otherwise, it's a replacement (delete + add)

      // Look for origWords[i] in upcoming modWords
      let foundInMod = -1;
      for (let k = j; k < Math.min(j + 5, modWords.length); k++) {
        if (modWords[k] === origWords[i]) {
          foundInMod = k;
          break;
        }
      }

      // Look for modWords[j] in upcoming origWords
      let foundInOrig = -1;
      for (let k = i; k < Math.min(i + 5, origWords.length); k++) {
        if (origWords[k] === modWords[j]) {
          foundInOrig = k;
          break;
        }
      }

      if (foundInMod !== -1 && (foundInOrig === -1 || foundInMod - j <= foundInOrig - i)) {
        // Words were added
        while (j < foundInMod) {
          result.push({ type: 'add', text: modWords[j++] });
        }
      } else if (foundInOrig !== -1) {
        // Words were removed
        while (i < foundInOrig) {
          result.push({ type: 'remove', text: origWords[i++] });
        }
      } else {
        // Replacement
        result.push({ type: 'remove', text: origWords[i++] });
        result.push({ type: 'add', text: modWords[j++] });
      }
    }
  }

  return result;
}

export function DiffView({ original, modified, isStreaming = false }: DiffViewProps) {
  const diff = useMemo(() => {
    if (!modified) return [];
    return computeWordDiff(original, modified);
  }, [original, modified]);

  if (!modified && isStreaming) {
    return (
      <div className="diff-view diff-view--streaming">
        <span className="diff-cursor" />
      </div>
    );
  }

  return (
    <div className="diff-view">
      {diff.map((item, idx) => (
        <span
          key={idx}
          className={`diff-${item.type}`}
        >
          {item.text}
        </span>
      ))}
      {isStreaming && <span className="diff-cursor" />}
    </div>
  );
}
```

This provides:
- Word-level diff with whitespace preservation
- Streaming cursor indicator
- CSS classes for styling (diff-same, diff-add, diff-remove)
  </action>
  <verify>
File exists at src/components/AiPreview/DiffView.tsx with DiffView export
  </verify>
  <done>
DiffView component displays word-level diff with streaming indicator
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StyleSelector component for choosing stylization mode</name>
  <files>
    src/components/AiPreview/StyleSelector.tsx
  </files>
  <action>
Create src/components/AiPreview/StyleSelector.tsx:

```tsx
import { useState } from 'react';
import { STYLE_PRESETS, StylePreset } from '../../stores/aiStore';

interface StyleSelectorProps {
  onSelect: (instructions: string) => void;
  disabled?: boolean;
}

export function StyleSelector({ onSelect, disabled = false }: StyleSelectorProps) {
  const [mode, setMode] = useState<'preset' | 'custom'>('preset');
  const [selectedPreset, setSelectedPreset] = useState<StylePreset>('formal');
  const [customInstructions, setCustomInstructions] = useState('');

  const handleApply = () => {
    if (mode === 'preset') {
      onSelect(STYLE_PRESETS[selectedPreset]);
    } else {
      if (customInstructions.trim()) {
        onSelect(customInstructions.trim());
      }
    }
  };

  const presetOptions: { value: StylePreset; label: string }[] = [
    { value: 'formal', label: 'More Formal' },
    { value: 'casual', label: 'More Casual' },
    { value: 'concise', label: 'More Concise' },
    { value: 'expand', label: 'Expand & Detail' },
    { value: 'simplify', label: 'Simplify' },
    { value: 'academic', label: 'Academic Style' },
    { value: 'creative', label: 'More Creative' },
    { value: 'persuasive', label: 'More Persuasive' },
  ];

  return (
    <div className="style-selector">
      <div className="style-selector__tabs">
        <button
          className={`style-selector__tab ${mode === 'preset' ? 'style-selector__tab--active' : ''}`}
          onClick={() => setMode('preset')}
          disabled={disabled}
        >
          Presets
        </button>
        <button
          className={`style-selector__tab ${mode === 'custom' ? 'style-selector__tab--active' : ''}`}
          onClick={() => setMode('custom')}
          disabled={disabled}
        >
          Custom
        </button>
      </div>

      {mode === 'preset' ? (
        <div className="style-selector__presets">
          <select
            value={selectedPreset}
            onChange={(e) => setSelectedPreset(e.target.value as StylePreset)}
            disabled={disabled}
            className="style-selector__select"
          >
            {presetOptions.map((opt) => (
              <option key={opt.value} value={opt.value}>
                {opt.label}
              </option>
            ))}
          </select>
          <p className="style-selector__description">
            {STYLE_PRESETS[selectedPreset]}
          </p>
        </div>
      ) : (
        <div className="style-selector__custom">
          <textarea
            value={customInstructions}
            onChange={(e) => setCustomInstructions(e.target.value)}
            placeholder="Enter your style instructions... (e.g., 'Make it sound like Shakespeare' or 'Add more technical details')"
            disabled={disabled}
            className="style-selector__textarea"
            rows={3}
          />
        </div>
      )}

      <button
        className="style-selector__apply"
        onClick={handleApply}
        disabled={disabled || (mode === 'custom' && !customInstructions.trim())}
      >
        Apply Style
      </button>
    </div>
  );
}
```

This provides:
- Toggle between preset and custom modes
- Dropdown for preset selection with descriptions
- Textarea for custom instructions
- Apply button to trigger stylization
  </action>
  <verify>
File exists at src/components/AiPreview/StyleSelector.tsx with StyleSelector export
  </verify>
  <done>
StyleSelector component allows preset selection or custom style instructions
  </done>
</task>

<task type="auto">
  <name>Task 3: Create main AiPreviewPanel and styles</name>
  <files>
    src/components/AiPreview/AiPreviewPanel.tsx
    src/components/AiPreview/index.ts
    src/styles/ai-preview.css
  </files>
  <action>
1. Create src/components/AiPreview/AiPreviewPanel.tsx:

```tsx
import { useCallback } from 'react';
import { useAiStore } from '../../stores/aiStore';
import { DiffView } from './DiffView';
import { StyleSelector } from './StyleSelector';
import '../../styles/ai-preview.css';

interface AiPreviewPanelProps {
  /** Called when user accepts the AI result */
  onAccept: (newText: string, range: { from: number; to: number }) => void;
  /** Called when user rejects the AI result */
  onReject: () => void;
  /** Document context for AI (surrounding text for tone matching) */
  documentContext?: string;
}

export function AiPreviewPanel({ onAccept, onReject, documentContext }: AiPreviewPanelProps) {
  const {
    isLoading,
    streamingText,
    error,
    originalText,
    originalRange,
    resultText,
    showPreview,
    startStylization,
    acceptResult,
    rejectResult,
    reset,
  } = useAiStore();

  const handleStyleSelect = useCallback(async (instructions: string) => {
    if (!originalText || !originalRange) return;
    try {
      await startStylization(originalText, originalRange, instructions, documentContext);
    } catch {
      // Error handled by store
    }
  }, [originalText, originalRange, documentContext, startStylization]);

  const handleAccept = useCallback(() => {
    if (resultText && originalRange) {
      onAccept(resultText, originalRange);
      acceptResult();
    }
  }, [resultText, originalRange, onAccept, acceptResult]);

  const handleReject = useCallback(() => {
    onReject();
    rejectResult();
  }, [onReject, rejectResult]);

  // Don't render if no preview state
  if (!showPreview && !error) {
    return null;
  }

  return (
    <div className="ai-preview-panel">
      <div className="ai-preview-panel__header">
        <h3 className="ai-preview-panel__title">AI Stylization</h3>
        <button
          className="ai-preview-panel__close"
          onClick={() => reset()}
          aria-label="Close"
        >
          &times;
        </button>
      </div>

      {error ? (
        <div className="ai-preview-panel__error">
          <p className="ai-preview-panel__error-text">{error}</p>
          <button className="ai-preview-panel__error-dismiss" onClick={() => reset()}>
            Dismiss
          </button>
        </div>
      ) : (
        <>
          {/* Style selection - show when not yet started or completed */}
          {!isLoading && !resultText && (
            <StyleSelector onSelect={handleStyleSelect} disabled={isLoading} />
          )}

          {/* Streaming/result view */}
          {(isLoading || resultText) && (
            <div className="ai-preview-panel__content">
              <div className="ai-preview-panel__original">
                <h4>Original</h4>
                <p>{originalText}</p>
              </div>

              <div className="ai-preview-panel__result">
                <h4>{isLoading ? 'Generating...' : 'AI Suggestion'}</h4>
                <DiffView
                  original={originalText}
                  modified={streamingText || resultText || ''}
                  isStreaming={isLoading}
                />
              </div>
            </div>
          )}

          {/* Action buttons - show when result is ready */}
          {resultText && !isLoading && (
            <div className="ai-preview-panel__actions">
              <button
                className="ai-preview-panel__reject"
                onClick={handleReject}
              >
                Reject
              </button>
              <button
                className="ai-preview-panel__accept"
                onClick={handleAccept}
              >
                Accept
              </button>
            </div>
          )}

          {/* Loading indicator */}
          {isLoading && (
            <div className="ai-preview-panel__loading">
              <span className="ai-preview-panel__spinner" />
              <span>Generating with Claude...</span>
            </div>
          )}
        </>
      )}
    </div>
  );
}
```

2. Create src/components/AiPreview/index.ts:

```typescript
export { AiPreviewPanel } from './AiPreviewPanel';
export { DiffView } from './DiffView';
export { StyleSelector } from './StyleSelector';
```

3. Create src/styles/ai-preview.css:

```css
/* AI Preview Panel */
.ai-preview-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 400px;
  max-height: 80vh;
  background: var(--color-surface, #ffffff);
  border: 1px solid var(--color-border, #e5e7eb);
  border-radius: 8px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

:root[data-theme="dark"] .ai-preview-panel {
  background: #1f2937;
  border-color: #374151;
}

.ai-preview-panel__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--color-border, #e5e7eb);
  background: var(--color-surface-alt, #f9fafb);
}

:root[data-theme="dark"] .ai-preview-panel__header {
  background: #111827;
  border-color: #374151;
}

.ai-preview-panel__title {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--color-text, #111827);
}

.ai-preview-panel__close {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: var(--color-text-muted, #6b7280);
  padding: 0;
  line-height: 1;
}

.ai-preview-panel__close:hover {
  color: var(--color-text, #111827);
}

/* Content area */
.ai-preview-panel__content {
  padding: 16px;
  overflow-y: auto;
  flex: 1;
}

.ai-preview-panel__original,
.ai-preview-panel__result {
  margin-bottom: 16px;
}

.ai-preview-panel__original h4,
.ai-preview-panel__result h4 {
  margin: 0 0 8px 0;
  font-size: 12px;
  font-weight: 500;
  color: var(--color-text-muted, #6b7280);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.ai-preview-panel__original p {
  margin: 0;
  padding: 12px;
  background: var(--color-surface-alt, #f3f4f6);
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.5;
  color: var(--color-text-muted, #6b7280);
}

:root[data-theme="dark"] .ai-preview-panel__original p {
  background: #111827;
}

/* Diff view */
.diff-view {
  padding: 12px;
  background: var(--color-surface-alt, #f9fafb);
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.6;
  min-height: 60px;
}

:root[data-theme="dark"] .diff-view {
  background: #111827;
}

.diff-same {
  color: var(--color-text, #111827);
}

.diff-add {
  background: #d1fae5;
  color: #065f46;
  border-radius: 2px;
}

:root[data-theme="dark"] .diff-add {
  background: #064e3b;
  color: #6ee7b7;
}

.diff-remove {
  background: #fee2e2;
  color: #991b1b;
  text-decoration: line-through;
  border-radius: 2px;
}

:root[data-theme="dark"] .diff-remove {
  background: #7f1d1d;
  color: #fca5a5;
}

.diff-cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: var(--color-primary, #3b82f6);
  animation: blink 1s infinite;
  vertical-align: text-bottom;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

/* Actions */
.ai-preview-panel__actions {
  display: flex;
  gap: 12px;
  padding: 16px;
  border-top: 1px solid var(--color-border, #e5e7eb);
}

:root[data-theme="dark"] .ai-preview-panel__actions {
  border-color: #374151;
}

.ai-preview-panel__accept,
.ai-preview-panel__reject {
  flex: 1;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
}

.ai-preview-panel__accept {
  background: #10b981;
  color: white;
}

.ai-preview-panel__accept:hover {
  background: #059669;
}

.ai-preview-panel__accept:active {
  transform: scale(0.98);
}

.ai-preview-panel__reject {
  background: var(--color-surface-alt, #e5e7eb);
  color: var(--color-text, #374151);
}

:root[data-theme="dark"] .ai-preview-panel__reject {
  background: #374151;
  color: #f3f4f6;
}

.ai-preview-panel__reject:hover {
  background: #d1d5db;
}

:root[data-theme="dark"] .ai-preview-panel__reject:hover {
  background: #4b5563;
}

/* Loading */
.ai-preview-panel__loading {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  color: var(--color-text-muted, #6b7280);
  font-size: 13px;
}

.ai-preview-panel__spinner {
  width: 16px;
  height: 16px;
  border: 2px solid var(--color-border, #e5e7eb);
  border-top-color: var(--color-primary, #3b82f6);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Error */
.ai-preview-panel__error {
  padding: 16px;
  text-align: center;
}

.ai-preview-panel__error-text {
  color: #dc2626;
  margin: 0 0 12px 0;
  font-size: 14px;
}

.ai-preview-panel__error-dismiss {
  padding: 8px 16px;
  background: var(--color-surface-alt, #e5e7eb);
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

/* Style Selector */
.style-selector {
  padding: 16px;
}

.style-selector__tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 12px;
}

.style-selector__tab {
  flex: 1;
  padding: 8px 12px;
  background: none;
  border: 1px solid var(--color-border, #e5e7eb);
  cursor: pointer;
  font-size: 13px;
  transition: all 0.15s;
}

.style-selector__tab:first-child {
  border-radius: 6px 0 0 6px;
}

.style-selector__tab:last-child {
  border-radius: 0 6px 6px 0;
}

.style-selector__tab--active {
  background: var(--color-primary, #3b82f6);
  border-color: var(--color-primary, #3b82f6);
  color: white;
}

.style-selector__select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--color-border, #e5e7eb);
  border-radius: 6px;
  font-size: 14px;
  background: var(--color-surface, #ffffff);
  color: var(--color-text, #111827);
  cursor: pointer;
}

:root[data-theme="dark"] .style-selector__select {
  background: #1f2937;
  border-color: #374151;
  color: #f3f4f6;
}

.style-selector__description {
  margin: 8px 0 0 0;
  font-size: 12px;
  color: var(--color-text-muted, #6b7280);
  line-height: 1.4;
}

.style-selector__textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--color-border, #e5e7eb);
  border-radius: 6px;
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
  background: var(--color-surface, #ffffff);
  color: var(--color-text, #111827);
}

:root[data-theme="dark"] .style-selector__textarea {
  background: #1f2937;
  border-color: #374151;
  color: #f3f4f6;
}

.style-selector__textarea::placeholder {
  color: var(--color-text-muted, #9ca3af);
}

.style-selector__apply {
  width: 100%;
  margin-top: 12px;
  padding: 10px 16px;
  background: var(--color-primary, #3b82f6);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s;
}

.style-selector__apply:hover:not(:disabled) {
  background: #2563eb;
}

.style-selector__apply:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```
  </action>
  <verify>
- All files exist in src/components/AiPreview/
- CSS file exists at src/styles/ai-preview.css
- TypeScript compiles: `npm run build` passes
  </verify>
  <done>
Complete AI preview UI: panel with streaming diff view, style selector, and accept/reject buttons with full styling
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` - no TypeScript errors
2. CSS is valid: No syntax errors in ai-preview.css
3. Component structure:
   - AiPreviewPanel renders correctly with mock data
   - DiffView shows differences between two strings
   - StyleSelector allows preset and custom selection
4. Visual verification: Import AiPreviewPanel in App.tsx, set mock showPreview state, verify styling
</verification>

<success_criteria>
- DiffView component shows word-level diff with add/remove highlighting
- StyleSelector provides presets and custom input
- AiPreviewPanel integrates all components with proper state handling
- Dark mode styling works correctly
- Loading state shows spinner and streaming cursor
- Accept/Reject buttons are visible when result is ready
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-integration/06-03-SUMMARY.md`
</output>
