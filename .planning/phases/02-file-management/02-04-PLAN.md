---
phase: 02-file-management
plan: 04
type: execute
wave: 4
depends_on: [02-03]
files_modified:
  - src/App.tsx
  - src/stores/editorStore.ts
autonomous: false

must_haves:
  truths:
    - "User sees 'Saving...' indicator during auto-save"
    - "User sees 'Saved' or timestamp after successful save"
    - "User sees dirty indicator (dot) for unsaved changes"
    - "All keyboard shortcuts work (Cmd+S, Cmd+Shift+S, Cmd+O, Cmd+N)"
    - "Native macOS dialogs appear for open/save operations"
    - "Documents persist across app restart"
  artifacts:
    - path: "src/App.tsx"
      provides: "Integrated file management UI"
      contains: "useAutoSave"
    - path: "src/stores/editorStore.ts"
      provides: "Auto-save state tracking"
      contains: "autoSaveStatus"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useKeyboardShortcuts.ts"
      via: "hook initialization"
      pattern: "useKeyboardShortcuts"
    - from: "src/App.tsx"
      to: "src/hooks/useAutoSave.ts"
      via: "hook initialization"
      pattern: "useAutoSave"
---

<objective>
Integrate all file management hooks into the app and verify complete functionality with human testing.

Purpose: This is the final integration and verification step that ensures all Phase 2 success criteria are met.

Output:
- App.tsx updated with auto-save indicator and hook integration
- Human verification of all 5 success criteria
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-file-management/02-RESEARCH.md
@.planning/phases/02-file-management/02-03-SUMMARY.md

# Existing code to modify
@src/App.tsx
@src/stores/editorStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-save status to store and update App.tsx</name>
  <files>
    - src/stores/editorStore.ts
    - src/App.tsx
  </files>
  <action>
    **Update `src/stores/editorStore.ts`:**

    Add auto-save status tracking:

    ```typescript
    type AutoSaveStatus = 'idle' | 'saving' | 'saved' | 'error'

    interface EditorState {
      // ... existing fields ...
      autoSaveStatus: AutoSaveStatus

      // ... existing actions ...
      setAutoSaveStatus: (status: AutoSaveStatus) => void
    }

    // In create():
    autoSaveStatus: 'idle',

    setAutoSaveStatus: (status) => set({ autoSaveStatus: status }),
    ```

    **Update `src/App.tsx`:**

    1. Add imports for new hooks:
    ```typescript
    import { useKeyboardShortcuts, useAutoSave } from './hooks'
    ```

    2. Initialize hooks after existing useRef/useState:
    ```typescript
    // Initialize keyboard shortcuts
    useKeyboardShortcuts(editorRef)

    // Initialize auto-save
    const { lastSave } = useAutoSave(editorRef, true)
    ```

    3. Update header to show save status. Replace the document name section with:
    ```tsx
    <div className="flex items-center gap-2">
      {document.isDirty && (
        <span className="text-orange-500 text-lg" title="Unsaved changes">â€¢</span>
      )}
      <span className="text-sm text-gray-600">{document.name}</span>
      {document.lastSaved && !document.isDirty && (
        <span className="text-xs text-gray-400">
          Saved {formatRelativeTime(document.lastSaved)}
        </span>
      )}
    </div>
    ```

    4. Add a simple relative time formatter at the top of the file:
    ```typescript
    function formatRelativeTime(date: Date): string {
      const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000)
      if (seconds < 60) return 'just now'
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`
      return date.toLocaleDateString()
    }
    ```

    5. Ensure the dirty indicator updates properly. The existing `handleUpdate` callback already calls `markDirty()`, which is correct.

    The header should now show:
    - Orange dot when document has unsaved changes
    - "Saved Xm ago" when document was auto-saved and has no pending changes
    - Document name always visible
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - App.tsx imports useKeyboardShortcuts and useAutoSave
    - App.tsx calls both hooks
    - Header shows dirty indicator and save timestamp
    - `npm run tauri dev` starts without errors
  </verify>
  <done>
    App.tsx updated with auto-save integration, keyboard shortcuts, and save status indicator.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete file management system with:
    - Native macOS open/save dialogs
    - .serq.html document format
    - Keyboard shortcuts (Cmd+S, Cmd+Shift+S, Cmd+O, Cmd+N)
    - Auto-save every 30 seconds
    - Recent files persistence
    - Save status indicator in header
  </what-built>
  <how-to-verify>
    Start the app: `npm run tauri dev`

    **Test 1: Create New Document (FILE-01, Success Criteria #1)**
    1. Press Cmd+N
    2. Verify editor clears and title shows "Untitled"
    3. Type some text
    4. Verify dirty indicator (orange dot) appears

    **Test 2: Save As (FILE-04, Success Criteria #3)**
    1. With text in editor, press Cmd+Shift+S
    2. Verify native macOS save dialog appears
    3. Save as "Test Document.serq.html" in Documents folder
    4. Verify title updates to "Test Document"
    5. Verify dirty indicator disappears
    6. Verify file exists: `cat ~/Documents/Test\ Document.serq.html`

    **Test 3: Open Document (FILE-02, Success Criteria #2)**
    1. Press Cmd+N to create new document
    2. Press Cmd+O
    3. Verify native macOS open dialog appears
    4. Navigate to ~/Documents and select "Test Document.serq.html"
    5. Verify content loads in editor
    6. Verify title shows "Test Document"

    **Test 4: Save Document (FILE-03, Success Criteria #3)**
    1. With the opened document, add more text
    2. Verify dirty indicator appears
    3. Press Cmd+S
    4. Verify dirty indicator disappears
    5. Verify "Saved just now" appears in header

    **Test 5: Auto-Save (FILE-05, Success Criteria #4)**
    1. Make changes to the document
    2. Wait 30-35 seconds without pressing Cmd+S
    3. Verify dirty indicator disappears automatically
    4. Verify console shows "[AutoSave] Document saved at..."
    5. Close and reopen the file to verify changes persisted

    **Test 6: Recent Files Persistence (FILE-07, Success Criteria #5)**
    1. Quit the app completely (Cmd+Q)
    2. Restart: `npm run tauri dev`
    3. Check preferences.json exists: `cat ~/Library/Application\ Support/com.serq.dev/preferences.json`
    4. Verify it contains the recently opened file path

    **Test 7: Production Build (Critical)**
    1. Build production: `npm run tauri build`
    2. Open the built app from target/release/bundle/macos/
    3. Repeat Test 2 (Save As) and Test 3 (Open)
    4. If this fails but dev mode worked, there's a permissions issue
  </how-to-verify>
  <resume-signal>
    Type "approved" if all 7 tests pass.
    If any test fails, describe:
    - Which test failed
    - Expected behavior
    - Actual behavior
    - Any error messages in console
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 is complete when all 5 success criteria from ROADMAP.md are verified:
1. User can create new document with File > New (via Cmd+N)
2. User can open existing .serq.html files via native macOS dialog
3. User can save document with Cmd+S and Save As with Cmd+Shift+S
4. User sees auto-save indicator and document saves every 30 seconds automatically
5. User can access recent files list (persisted in preferences.json)
</verification>

<success_criteria>
- All 7 verification tests pass
- Production build works identically to dev mode
- No permission errors on file operations
- Auto-save triggers reliably after 30 seconds of idle
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-management/02-04-SUMMARY.md`
</output>
