---
phase: 02-file-management
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/hooks/useAutoSave.ts
  - src/lib/recentFiles.ts
  - src/hooks/useFileOperations.ts
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Document auto-saves every 30 seconds when dirty and has a file path"
    - "Auto-save does NOT trigger on new unsaved documents (no path)"
    - "Auto-save debounces rapid changes (doesn't save on every keystroke)"
    - "Recent files list persists across app restarts"
    - "Opening a file adds it to recent files list"
    - "Recent files list is capped at 10 entries (FIFO)"
  artifacts:
    - path: "src/hooks/useAutoSave.ts"
      provides: "Auto-save logic with 30-second debounce"
      exports: ["useAutoSave"]
      min_lines: 40
    - path: "src/lib/recentFiles.ts"
      provides: "Recent files persistence via tauri-plugin-store"
      exports: ["getRecentFiles", "addRecentFile", "clearRecentFiles", "removeRecentFile"]
      min_lines: 50
  key_links:
    - from: "src/hooks/useAutoSave.ts"
      to: "@tauri-apps/plugin-fs"
      via: "writeTextFile for auto-save"
      pattern: "import.*from '@tauri-apps/plugin-fs'"
    - from: "src/hooks/useAutoSave.ts"
      to: "use-debounce"
      via: "useDebouncedCallback for 30-second delay"
      pattern: "useDebouncedCallback"
    - from: "src/lib/recentFiles.ts"
      to: "@tauri-apps/plugin-store"
      via: "load() for persistent preferences"
      pattern: "import.*from '@tauri-apps/plugin-store'"
    - from: "src/hooks/useFileOperations.ts"
      to: "src/lib/recentFiles.ts"
      via: "addRecentFile on open/save"
      pattern: "import.*from.*recentFiles"
---

<objective>
Add auto-save functionality with 30-second debounce and recent files list persistence.

Purpose: Prevents data loss from crashes/power failures (auto-save) and improves UX by remembering recently opened files.

Output:
- `useAutoSave` hook that saves dirty documents every 30 seconds
- `recentFiles.ts` library for persistent recent files list
- File operations updated to track recent files
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-file-management/02-RESEARCH.md
@.planning/phases/02-file-management/02-02-SUMMARY.md

# Existing code to modify/integrate
@src/hooks/useFileOperations.ts
@src/stores/editorStore.ts
@src/lib/serqFormat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAutoSave hook with debounce</name>
  <files>
    - src/hooks/useAutoSave.ts
    - src/hooks/index.ts
  </files>
  <action>
    Create `src/hooks/useAutoSave.ts`:

    The hook should:
    1. Accept `editorRef: React.RefObject<EditorCoreRef>` and optional `enabled: boolean = true`
    2. Use `useDebouncedCallback` from 'use-debounce' with 30000ms delay
    3. Track last save time via useRef
    4. Return `{ lastSave, flushAutoSave }`

    Implementation details:

    ```typescript
    const AUTO_SAVE_INTERVAL = 30000 // 30 seconds

    export function useAutoSave(
      editorRef: React.RefObject<EditorCoreRef>,
      enabled: boolean = true
    ) {
      const { document, markSaved } = useEditorStore()
      const lastSaveRef = useRef<Date | null>(null)

      const performAutoSave = useDebouncedCallback(
        async () => {
          // Guard conditions - don't auto-save if:
          // 1. No file path (new document, use Save As instead)
          // 2. Document isn't dirty (nothing to save)
          // 3. Editor ref isn't available
          if (!document.path || !document.isDirty) return
          if (!editorRef.current) return

          try {
            const html = editorRef.current.getHTML()
            const content = serializeSerqDocument(html, document)
            await writeTextFile(document.path, content)

            markSaved()
            lastSaveRef.current = new Date()
            console.log('[AutoSave] Document saved at', lastSaveRef.current)
          } catch (error) {
            console.error('[AutoSave] Failed:', error)
            // Don't mark as saved on error - user will see dirty indicator
          }
        },
        AUTO_SAVE_INTERVAL,
        { maxWait: AUTO_SAVE_INTERVAL * 2 } // Force save after 60s even if still typing
      )

      // Trigger auto-save when document becomes dirty
      useEffect(() => {
        if (enabled && document.isDirty && document.path) {
          performAutoSave()
        }
      }, [document.isDirty, document.path, enabled, performAutoSave])

      // Flush pending auto-save on unmount (app close)
      useEffect(() => {
        return () => {
          performAutoSave.flush()
        }
      }, [performAutoSave])

      return {
        lastSave: lastSaveRef.current,
        flushAutoSave: performAutoSave.flush,
      }
    }
    ```

    Key behaviors:
    - Auto-save only triggers when document has a path AND is dirty
    - 30-second debounce means rapid typing doesn't cause constant saves
    - maxWait of 60 seconds ensures save eventually happens during long typing sessions
    - Flush on unmount catches app close scenarios

    Update `src/hooks/index.ts` to export:
    ```typescript
    export { useAutoSave } from './useAutoSave'
    ```
  </action>
  <verify>
    - File exists at `src/hooks/useAutoSave.ts`
    - `npx tsc --noEmit` passes
    - Hook imports useDebouncedCallback from 'use-debounce'
    - Hook uses 30000ms (30 seconds) as interval
    - Hook is exported from index.ts
  </verify>
  <done>
    useAutoSave hook created with 30-second debounced auto-save that only triggers for saved documents with unsaved changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create recentFiles library and integrate with file operations</name>
  <files>
    - src/lib/recentFiles.ts
    - src/hooks/useFileOperations.ts
  </files>
  <action>
    Create `src/lib/recentFiles.ts`:

    ```typescript
    import { load } from '@tauri-apps/plugin-store'

    const MAX_RECENT_FILES = 10
    const STORE_FILE = 'preferences.json'

    interface RecentFile {
      path: string
      name: string
      lastOpened: string // ISO timestamp
    }

    let storeInstance: Awaited<ReturnType<typeof load>> | null = null

    async function getStore() {
      if (!storeInstance) {
        storeInstance = await load(STORE_FILE, { autoSave: false })
      }
      return storeInstance
    }

    export async function getRecentFiles(): Promise<RecentFile[]> {
      const store = await getStore()
      const files = await store.get<RecentFile[]>('recentFiles')
      return files ?? []
    }

    export async function addRecentFile(path: string, name: string): Promise<void> {
      const store = await getStore()
      let files = await getRecentFiles()

      // Remove if already exists (will re-add at top)
      files = files.filter(f => f.path !== path)

      // Add to front of list
      files.unshift({
        path,
        name,
        lastOpened: new Date().toISOString(),
      })

      // Trim to max (FIFO - oldest falls off)
      files = files.slice(0, MAX_RECENT_FILES)

      await store.set('recentFiles', files)
      await store.save()
    }

    export async function clearRecentFiles(): Promise<void> {
      const store = await getStore()
      await store.set('recentFiles', [])
      await store.save()
    }

    export async function removeRecentFile(path: string): Promise<void> {
      const store = await getStore()
      let files = await getRecentFiles()
      files = files.filter(f => f.path !== path)
      await store.set('recentFiles', files)
      await store.save()
    }

    export type { RecentFile }
    ```

    Update `src/hooks/useFileOperations.ts`:

    Add import at top:
    ```typescript
    import { addRecentFile } from '../lib/recentFiles'
    ```

    In `openFile()`, after successfully loading file and updating store:
    ```typescript
    // Add to recent files
    await addRecentFile(filePath, extractFileName(filePath))
    ```

    In `saveFileAs()`, after successfully saving to new path:
    ```typescript
    // Add to recent files
    await addRecentFile(filePath, extractFileName(filePath))
    ```

    Note: Regular `saveFile()` doesn't need to update recent files - the file was already opened/created.
  </action>
  <verify>
    - File exists at `src/lib/recentFiles.ts`
    - `npx tsc --noEmit` passes
    - recentFiles exports getRecentFiles, addRecentFile, clearRecentFiles, removeRecentFile
    - useFileOperations imports from recentFiles
    - useFileOperations calls addRecentFile on open and save-as
  </verify>
  <done>
    Recent files persistence created and integrated into file operations. Opening or saving-as a file adds it to the recent files list (max 10, persisted across restarts).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles: `npx tsc --noEmit`
2. Auto-save interval is 30000ms (30 seconds)
3. Recent files stored in preferences.json via tauri-plugin-store
4. MAX_RECENT_FILES is 10
</verification>

<success_criteria>
- useAutoSave triggers only for dirty documents with existing file path
- Auto-save uses 30-second debounce with 60-second max wait
- Recent files list persists across app restarts
- Recent files capped at 10 entries
- Open and Save As operations add to recent files
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-management/02-03-SUMMARY.md`
</output>
