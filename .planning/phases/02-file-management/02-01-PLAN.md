---
phase: 02-file-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/src/lib.rs
  - src-tauri/capabilities/default.json
  - package.json
  - src/lib/serqFormat.ts
autonomous: true

must_haves:
  truths:
    - "Tauri FS plugin can read files from $HOME"
    - "Tauri FS plugin can write files to $HOME"
    - "Tauri dialog plugin shows native macOS open/save dialogs"
    - "Tauri store plugin persists key-value data across app restarts"
    - ".serq.html format preserves both content and metadata"
  artifacts:
    - path: "src-tauri/capabilities/default.json"
      provides: "File system permissions for $HOME/**"
      contains: "fs:allow-read"
    - path: "src-tauri/Cargo.toml"
      provides: "Rust plugin dependencies"
      contains: "tauri-plugin-fs"
    - path: "src-tauri/src/lib.rs"
      provides: "Plugin registration"
      contains: "tauri_plugin_fs::init()"
    - path: "src/lib/serqFormat.ts"
      provides: "Document serialization/deserialization"
      exports: ["serializeSerqDocument", "parseSerqDocument", "SerqMetadata"]
  key_links:
    - from: "src-tauri/src/lib.rs"
      to: "src-tauri/Cargo.toml"
      via: "plugin dependencies imported and registered"
      pattern: "tauri_plugin_fs::init\\(\\)"
    - from: "src-tauri/capabilities/default.json"
      to: "tauri runtime"
      via: "permission scoping for file operations"
      pattern: "\\$HOME/\\*\\*"
---

<objective>
Configure Tauri plugins and permissions for file operations, then create the .serq.html document format.

Purpose: This is the CRITICAL foundation - file operations will fail in production builds without proper permission scoping. The research explicitly warns: "Dev mode is more permissive than production builds."

Output:
- Tauri plugins installed (fs, dialog, store)
- FS permissions configured for `$HOME/**`
- .serq.html format library ready for use
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-management/02-RESEARCH.md

# Existing files to modify
@src-tauri/Cargo.toml
@src-tauri/src/lib.rs
@src-tauri/capabilities/default.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Tauri plugins and npm dependencies</name>
  <files>
    - src-tauri/Cargo.toml
    - package.json
  </files>
  <action>
    Install Tauri plugins via CLI (this updates both Cargo.toml and registers plugins):

    ```bash
    cd /Users/jacquesdubnov/Coding/serq
    npm run tauri add fs
    npm run tauri add dialog
    npm run tauri add store
    ```

    Install npm packages for frontend bindings and utilities:

    ```bash
    npm install @tauri-apps/plugin-fs @tauri-apps/plugin-dialog @tauri-apps/plugin-store
    npm install react-hotkeys-hook use-debounce
    ```

    Verify Cargo.toml has these dependencies added:
    - tauri-plugin-fs = "2"
    - tauri-plugin-dialog = "2"
    - tauri-plugin-store = "2"
  </action>
  <verify>
    - `grep "tauri-plugin-fs" src-tauri/Cargo.toml` shows version 2
    - `grep "@tauri-apps/plugin-fs" package.json` shows installed
    - `grep "react-hotkeys-hook" package.json` shows installed
  </verify>
  <done>
    All Tauri plugins (fs, dialog, store) and npm packages (plugin bindings, react-hotkeys-hook, use-debounce) installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Tauri FS permissions for $HOME access</name>
  <files>
    - src-tauri/capabilities/default.json
    - src-tauri/src/lib.rs
  </files>
  <action>
    Update `src-tauri/capabilities/default.json` to grant file system access to user's home directory:

    ```json
    {
      "$schema": "https://schema.tauri.app/config/2/capability",
      "identifier": "default",
      "description": "Default capabilities for SERQ document editor",
      "windows": ["main"],
      "permissions": [
        "core:default",
        "shell:allow-open",
        "fs:default",
        "dialog:default",
        "store:default",
        {
          "identifier": "fs:allow-read",
          "allow": [
            { "path": "$HOME" },
            { "path": "$HOME/**" }
          ]
        },
        {
          "identifier": "fs:allow-write",
          "allow": [
            { "path": "$HOME" },
            { "path": "$HOME/**" }
          ]
        },
        {
          "identifier": "fs:allow-exists",
          "allow": [
            { "path": "$HOME" },
            { "path": "$HOME/**" }
          ]
        },
        {
          "identifier": "fs:allow-stat",
          "allow": [
            { "path": "$HOME" },
            { "path": "$HOME/**" }
          ]
        }
      ]
    }
    ```

    Update `src-tauri/src/lib.rs` to register all plugins:

    ```rust
    #[tauri::command]
    fn greet(name: &str) -> String {
        format!("Hello, {}! Welcome to SERQ.", name)
    }

    #[cfg_attr(mobile, tauri::mobile_entry_point)]
    pub fn run() {
        tauri::Builder::default()
            .plugin(tauri_plugin_shell::init())
            .plugin(tauri_plugin_fs::init())
            .plugin(tauri_plugin_dialog::init())
            .plugin(tauri_plugin_store::Builder::new().build())
            .invoke_handler(tauri::generate_handler![greet])
            .run(tauri::generate_context!())
            .expect("error while running tauri application");
    }
    ```

    CRITICAL: The permission scopes MUST include `$HOME/**` (not just AppData). Without this, file operations fail silently in production builds even if they work in dev mode.
  </action>
  <verify>
    - `cat src-tauri/capabilities/default.json | grep -c "HOME"` returns at least 4 (read, write, exists, stat)
    - `grep "tauri_plugin_fs::init()" src-tauri/src/lib.rs` returns a match
    - `cargo check --manifest-path src-tauri/Cargo.toml` compiles without errors
  </verify>
  <done>
    Tauri plugins registered and FS permissions configured for full $HOME access.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create .serq.html format library</name>
  <files>
    - src/lib/serqFormat.ts
  </files>
  <action>
    Create the `src/lib/` directory if it doesn't exist.

    Create `src/lib/serqFormat.ts` implementing the .serq.html document format:

    The format embeds JSON metadata in a script tag within a valid HTML document. This allows .serq.html files to:
    1. Open in any browser and render correctly
    2. Preserve SERQ-specific metadata (word count, presets, timestamps)
    3. Be edited by the TipTap editor

    Key implementation details:
    - Metadata goes in `<script type="application/json" id="serq-metadata">`
    - HTML content goes in `<body class="serq-document">`
    - CRITICAL: Escape `</script>` in JSON as `<\/script>` to prevent breaking the HTML
    - Include a basic inline stylesheet so documents render reasonably in browsers

    Interface:
    ```typescript
    export interface SerqMetadata {
      version: string
      created: string
      modified: string
      wordCount: number
      presets?: {
        typography?: string
        colors?: string
        layout?: string
      }
    }

    export function serializeSerqDocument(
      html: string,
      documentMeta: { name: string; path?: string | null }
    ): string

    export function parseSerqDocument(content: string): {
      html: string
      metadata: SerqMetadata
    }
    ```

    Include helper functions:
    - `countWords(html: string): number` - Strip tags, count whitespace-separated words
    - `escapeHtml(str: string): string` - Escape &, <, >, " for safe HTML attribute embedding
  </action>
  <verify>
    - File exists at `src/lib/serqFormat.ts`
    - `npx tsc --noEmit` passes (TypeScript compiles)
    - Exports `serializeSerqDocument` and `parseSerqDocument` functions
    - Exports `SerqMetadata` interface
  </verify>
  <done>
    .serq.html format library created with serialize/deserialize functions that preserve content and metadata.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run tauri dev` starts without plugin errors
2. All Tauri plugins load (check console for init messages)
3. `cargo check --manifest-path src-tauri/Cargo.toml` passes
4. TypeScript compiles without errors
</verification>

<success_criteria>
- Tauri plugins (fs, dialog, store) installed and registered
- FS permissions allow read/write/exists/stat on $HOME/**
- .serq.html format can serialize editor HTML + metadata
- .serq.html format can parse files back to HTML + metadata
- All dependencies verified via CLI commands
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-management/02-01-SUMMARY.md`
</output>
